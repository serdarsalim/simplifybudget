<script>
/**
 * settings.js - Simplified JavaScript for SimBudget Settings page
 * Provides clean, professional settings functionality without animations
 */

// Settings page functionality
const SettingsPage = (function() {
  // Private variables
  let _initialized = false;
  
 const currencyOptions = [
  { symbol: '$', code: 'USD', name: 'US Dollar' },
  { symbol: '€', code: 'EUR', name: 'Euro' },
  { symbol: '£', code: 'GBP', name: 'British Pound' },
  { symbol: '¥', code: 'JPY', name: 'Japanese Yen' },
  { symbol: '₹', code: 'INR', name: 'Indian Rupee' },
  { symbol: '₽', code: 'RUB', name: 'Russian Ruble' },
  { symbol: '¥', code: 'CNY', name: 'Chinese Yuan' },
  { symbol: '₺', code: 'TRY', name: 'Turkish Lira' },
  { symbol: 'C$', code: 'CAD', name: 'Canadian Dollar' },
  { symbol: 'A$', code: 'AUD', name: 'Australian Dollar' },
  { symbol: 'CHF', code: 'CHF', name: 'Swiss Franc' },
  { symbol: 'R$', code: 'BRL', name: 'Brazilian Real' },
  { symbol: '₩', code: 'KRW', name: 'South Korean Won' },
  { symbol: 'د.إ', code: 'AED', name: 'UAE Dirham' },
  { symbol: '₫', code: 'VND', name: 'Vietnamese Dong' },
  { symbol: 'RM', code: 'MYR', name: 'Malaysian Ringgit' },
  { symbol: '฿', code: 'THB', name: 'Thai Baht' },
  { symbol: '₦', code: 'NGN', name: 'Nigerian Naira' },
  { symbol: '₴', code: 'UAH', name: 'Ukrainian Hryvnia' },
  { symbol: 'د.ا', code: 'JOD', name: 'Jordanian Dinar' }
];


  /**
   * Initialize settings page functionality
   */
  function init() {
    if (_initialized) return;
      buildCurrencyOptions();
    // Load existing settings values
    loadSavedSettings();
    initEventListeners();
    initGoogleTranslate();
    _initialized = true;
    console.log('Settings page initialized');
  }
  
  /**
   * Initialize event listeners
   */
  /**
 * Initialize event listeners with autosave
 */
function initEventListeners() {
  // Create a debounce function for autosaving
  const debounceAutoSave = Utils.debounce(function() {
    saveSettings(true); // true = silent save (no notification)
  }, 500);
  
  // Set up form controls with autosave
  document.querySelectorAll('#currencySelector, #dateFormat, #showDecimals, #showRemaining, #enableAlerts')
    .forEach(element => {
      element.addEventListener('change', debounceAutoSave);
    });
  
  // Dark mode has additional UI impact
  const darkModeToggle = document.getElementById('darkMode');
  if (darkModeToggle) {
    darkModeToggle.addEventListener('change', function() {
      document.body.classList.toggle('dark-mode', this.checked);
      debounceAutoSave();
    });
  }
    
  // Keep reset button
  const resetButton = document.getElementById('resetSettings');
  if (resetButton) {
    resetButton.addEventListener('click', resetSettings);
  }
  
  // Test connection button
  const testConnectionBtn = document.getElementById('testConnection');
  if (testConnectionBtn) {
    testConnectionBtn.addEventListener('click', testConnection);
  }

  // Language selector needs special handling
  const languageSelector = document.getElementById('languageSelector');
  if (languageSelector) {
    languageSelector.addEventListener('change', function() {
      const selectedLanguage = this.value;
      changeLanguage(selectedLanguage);
    });
  }

  // Sheet URL needs special handling - save on blur
  const sheetUrlInput = document.getElementById('budgetSheetUrl');
  if (sheetUrlInput) {
    sheetUrlInput.addEventListener('blur', debounceAutoSave);
  }
  

}
  

  /**
 * Load translations and apply them to the UI
 * @param {string} langCode - Language code to apply
 */
function applyTranslations(langCode) {
  // Show loading state
  const statusEl = document.getElementById('settingsStatus');
  if (statusEl) {
    statusEl.className = 'status-message';
     statusEl.classList.add('success');
    statusEl.textContent = 'Loading translations...';
    statusEl.classList.remove('hidden');
  }
  
  // Call the server to get translations
  API.getTranslations(langCode, 
    function(result) {
      if (result && result.translations) {
        // Store translations in global variable for easy access
        window.SimBudget = window.SimBudget || {};
        SimBudget.translations = result.translations;
        
        // Update all text elements with the class "translatable"
        document.querySelectorAll('[data-translate]').forEach(el => {
          const key = el.getAttribute('data-translate');
          if (key && SimBudget.translations[key]) {
            el.textContent = SimBudget.translations[key];
          }
        });
        
        // Update all placeholder attributes
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
          const key = el.getAttribute('data-translate-placeholder');
          if (key && SimBudget.translations[key]) {
            el.setAttribute('placeholder', SimBudget.translations[key]);
          }
        });
        
        // Update all title attributes
        document.querySelectorAll('[data-translate-title]').forEach(el => {
          const key = el.getAttribute('data-translate-title');
          if (key && SimBudget.translations[key]) {
            el.setAttribute('title', SimBudget.translations[key]);
          }
        });
        
        // Hide loading status
        if (statusEl) {
          statusEl.classList.add('hidden');
        }
        
        console.log('Translations applied successfully for: ' + langCode);
      } else {
        // Show error
        if (statusEl) {
          statusEl.textContent = 'Error loading translations';
          statusEl.className = 'status-message error';
        }
      }
    },
    function(error) {
      // Show error
      if (statusEl) {
        statusEl.textContent = 'Error loading translations: ' + error;
        statusEl.className = 'status-message error';
      }
    }
  );
}


/**
 * Change the language and apply translations
 * @param {string} langCode - Language code to change to
 */
function changeLanguage(langCode) {
  // Save the language preference
  API.setUserLanguage(langCode, 
    function(result) {
      // Clear client-side cached translations
      window.SimBudget = window.SimBudget || {};
      if (SimBudget.translations) {
        delete SimBudget.translations;
      }
      
      // Get fresh translations with cache busting (true parameter)
      API.getTranslations(langCode, 
        function(result) {
          // Apply fresh translations to UI
          applyTranslations(langCode);
          
          // Update saved settings
          if (window.SimBudget && SimBudget.Settings) {
            const settings = SimBudget.Settings.getAll();
            settings.language = langCode;
            SimBudget.Settings.saveAll(settings);
          }
          
          console.log('Language changed to', langCode);
        },
        function(error) {
          Utils.showToast('Error changing language: ' + error, 'error');
        },
        true  // This is the cache-busting parameter
      );
    },
    function(error) {
      Utils.showToast('Error saving language preference: ' + error, 'error');
    }
  );
}



/**
 * Build currency dropdown options
 */
function buildCurrencyOptions() {
  const currencySelect = document.getElementById('currencySelector');
  if (!currencySelect) return;
  
  // Get defaults from SimBudget if available
  const defaultCurrency = (window.SimBudget && SimBudget.Settings && SimBudget.Settings.defaults) 
    ? SimBudget.Settings.defaults.currencySymbol || '$' 
    : '$';
  
  // Clear existing options
  currencySelect.innerHTML = '';
  
  // Add options for each currency
  currencyOptions.forEach(currency => {
    const option = document.createElement('option');
    option.value = currency.symbol;
    option.textContent = `${currency.symbol} - ${currency.name} (${currency.code})`;
    currencySelect.appendChild(option);
  });
  
  // Set default value after adding options
  currencySelect.value = defaultCurrency;
}

  /**
   * Load saved settings from localStorage
   */
 function loadSavedSettings() {
  // Use the SimBudget.Settings object if available
  if (window.SimBudget && SimBudget.Settings) {
    const settings = SimBudget.Settings.getAll();
    
    // Apply settings to form elements
    const currencySelect = document.getElementById('currencySelector');
    if (currencySelect) {
      currencySelect.value = settings.currencySymbol || '$';
      // If saved currency isn't in dropdown, add it as an option
      if (!currencySelect.value) {
        const option = document.createElement('option');
        option.value = settings.currencySymbol;
        option.textContent = settings.currencySymbol;
        currencySelect.appendChild(option);
        currencySelect.value = settings.currencySymbol;
      }
    }
    
      
      const dateFormatSelect = document.getElementById('dateFormat');
      if (dateFormatSelect) {
        dateFormatSelect.value = settings.dateFormat || 'MM/DD/YYYY';
      }
      
      const darkModeCheckbox = document.getElementById('darkMode');
      if (darkModeCheckbox) {
        darkModeCheckbox.checked = settings.darkMode || false;
        // Apply dark mode to body if enabled
        document.body.classList.toggle('dark-mode', settings.darkMode);
      }
      
      const languageSelector = document.getElementById('languageSelector');
if (languageSelector) {
  languageSelector.addEventListener('change', function() {
    const selectedLanguage = this.value;
    
    // Save the language
    API.setUserLanguage(selectedLanguage, 
      function(result) {
        // Load and apply translations
        applyTranslations(selectedLanguage);
      },
      function(error) {
        Utils.showToast('Error changing language: ' + error, 'error');
      }
    );
  });
}
      
      const showRemainingCheckbox = document.getElementById('showRemaining');
      if (showRemainingCheckbox) {
        showRemainingCheckbox.checked = settings.showRemaining !== undefined ? 
          settings.showRemaining : true;
      }
      
      const enableAlertsCheckbox = document.getElementById('enableAlerts');
      if (enableAlertsCheckbox) {
        enableAlertsCheckbox.checked = settings.enableAlerts !== undefined ? 
          settings.enableAlerts : true;
      }
      
      const showDecimalsCheckbox = document.getElementById('showDecimals');
      if (showDecimalsCheckbox) {
        showDecimalsCheckbox.checked = settings.showDecimals !== undefined ? 
          settings.showDecimals : true;
      }
    }
  }
  
    /**
     * Save settings to localStorage
     * @param {boolean} silent - Whether to show success message
     */
    function saveSettings(silent = false) {
    // Get values from form
    const settings = {
      currencySymbol: document.getElementById('currencySelector').value || '$',
      dateFormat: document.getElementById('dateFormat').value || 'MM/DD/YYYY',
      darkMode: document.getElementById('darkMode').checked || false,
      showRemaining: document.getElementById('showRemaining').checked || false,
      enableAlerts: document.getElementById('enableAlerts').checked || false,
      language: document.getElementById('languageSelector').value || 'en',
      showDecimals: document.getElementById('showDecimals').checked || false
    };
    
    // Use the SimBudget.Settings object if available
    if (window.SimBudget && SimBudget.Settings) {
      // Save settings
      const success = SimBudget.Settings.saveAll(settings);
      
        // Just update these lines that show status messages
        if (success) {
          // Save sheet URL if provided
          const sheetUrl = document.getElementById('budgetSheetUrl').value;
          if (sheetUrl) {
            API.setBudgetSheetUrl(sheetUrl, 
              function() {
                if (!silent) showStatus('Settings saved successfully', false);
              },
              function(error) {
                showStatus('Settings saved but sheet URL could not be saved: ' + error, true);
              }
            );
          } else if (!silent) {
            showStatus('Settings saved automatically', false);
          }
        } else {
          showStatus('Error saving settings', true);
        }

        // And the same for the localStorage fallback
        try {
          localStorage.setItem('simbudget_settings', JSON.stringify(settings));
          if (!silent) showStatus('Settings saved successfully', false);
        } catch (e) {
          showStatus('Error saving settings: ' + e.message, true);
          }
          }
        }
  
  /**
   * Reset settings to defaults
   */
  function resetSettings() {
    // Use the SimBudget.Settings object if available
    if (window.SimBudget && SimBudget.Settings) {
      const defaults = SimBudget.Settings.defaults;
      
      // Reset to defaults
      if (SimBudget.Settings.saveAll(defaults)) {
        // Update form values
        document.getElementById('currencySelector').value = defaults.currencySymbol || '$';
        document.getElementById('dateFormat').value = defaults.dateFormat || 'MM/DD/YYYY';
        document.getElementById('darkMode').checked = defaults.darkMode || false;
        document.getElementById('showRemaining').checked = defaults.showRemaining !== undefined ? 
          defaults.showRemaining : true;
        document.getElementById('enableAlerts').checked = defaults.enableAlerts !== undefined ? 
          defaults.enableAlerts : true;
        document.getElementById('languageSelector').value = defaults.language || 'en';
        document.getElementById('showDecimals').checked = defaults.showDecimals !== undefined ? 
          defaults.showDecimals : true;
        
        // Update dark mode
        document.body.classList.toggle('dark-mode', defaults.darkMode || false);
        
        showStatus('Settings reset to defaults', false);
      } else {
        showStatus('Error resetting settings', true);
      }
    }
  }
  
  /**
   * Test connection to sheet
   */
  function testConnection() {
    const sheetUrl = document.getElementById('budgetSheetUrl').value;
    if (!sheetUrl) {
      showStatus('Please enter a spreadsheet URL', true);
      return;
    }
    
    // Show loading state
    showStatus('Testing connection...', false);
    
    API.verifySheetUrl(sheetUrl,
      function(result) {
        showStatus('Connection successful!', false);
      },
      function(error) {
        showStatus('Connection failed: ' + error, true);
      }
    );
  }
  
  /**
   * Show a status message
   * @param {string} message - Message to display
   * @param {boolean} isError - Whether this is an error message
   */
  function showStatus(message, isError) {
    const statusEl = document.getElementById('settingsStatus');
    if (!statusEl) return;
    
    // Clear existing classes and content
    statusEl.className = 'status-message';
    statusEl.textContent = message;
    
    // Add appropriate class
    statusEl.classList.add(isError ? 'error' : 'success');
    
    // Show the message
    statusEl.classList.remove('hidden');
    
    // Auto-hide success messages after 5 seconds
    if (!isError) {
      setTimeout(function() {
        statusEl.classList.add('hidden');
      }, 5000);
    }
  }
  
  // Public API
  return {
    init: init,
    saveSettings: saveSettings,
    resetSettings: resetSettings,
    testConnection: testConnection
  };
})();

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize settings page
  SettingsPage.init();
});

</script>