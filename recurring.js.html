<script>
// ============================================================================
// CLIENT-SIDE RECURRING MODULE (Replace existing recurring module)
// ============================================================================

/**
 * Enhanced RecurringManager - Real data integration with spreadsheet
 */
var RecurringManager = (function() {
  // Private variables
  let _initialized = false;
  let _recurringData = [];
  let _categories = [];
  let _currencySymbol = '$';
  let _showDecimals = true;
  let _language = 'en';
  
  // Session-level cache
  let _sessionCache = null;
  const SESSION_KEY = 'recurringManager_sessionData';
  
  // DOM element cache
  const _elements = {};
  
  /**
   * Get element with caching
   */
  function getElement(id) {
    if (!_elements[id]) {
      _elements[id] = document.getElementById(id);
    }
    return _elements[id];
  }

  /**
   * Load settings from SimBudget
   */
  function loadSettings() {
    console.log('RecurringManager: Loading settings...');
    
    if (window.SimBudget && SimBudget.Settings) {
      _currencySymbol = SimBudget.Settings.getCurrencySymbol() || '$';
      _showDecimals = SimBudget.Settings.showDecimals() || true;
      _language = SimBudget.Settings.getSetting('language') || 'en';
      
      console.log('RecurringManager: Settings loaded -', {
        currency: _currencySymbol,
        decimals: _showDecimals,
        language: _language
      });
    }
  }

  /**
   * Format currency with user settings
   */
  function formatCurrency(amount) {
    const decimals = _showDecimals ? 2 : 0;
    return `${_currencySymbol}${amount.toFixed(decimals)}`;
  }

  /**
   * Initialize the Recurring Manager
   */
  function init(containerId) {
    if (_initialized && !containerId) {
      return;
    }
    
    console.log('RecurringManager: Initializing...', containerId);
    
    // Load user settings
    loadSettings();
    
    // Find container
    const container = containerId ? 
      document.getElementById(containerId) : 
      getElement('recurringContent');
    
    if (!container) {
      console.error('RecurringManager: Container not found');
      return;
    }
    
    _elements['recurringContent'] = container;
    
    // Load categories
    loadCategories();
    
    // Check session cache first for immediate display
    if (checkSessionCache()) {
      console.log('RecurringManager: Using session cache');
      renderRecurringView();
      bindEvents();
      
      // Still fetch fresh data in background
      setTimeout(() => {
        loadRealRecurringData(true); // Background refresh
      }, 1000);
    } else {
      // No cache, load fresh data
      loadRealRecurringData();
    }
    
    _initialized = true;
  }

  /**
   * Check session cache for immediate display
   */
  function checkSessionCache() {
    try {
      const cached = sessionStorage.getItem(SESSION_KEY);
      if (cached) {
        const data = JSON.parse(cached);
        const age = Date.now() - data.timestamp;
        
        // Use cache if less than 5 minutes old
        if (age < 5 * 60 * 1000) {
          _recurringData = data.recurring || [];
          return true;
        }
      }
    } catch (error) {
      console.warn('RecurringManager: Error reading session cache', error);
    }
    return false;
  }

  /**
   * Save data to session cache
   */
  function saveToSessionCache(data) {
    try {
      const cacheData = {
        timestamp: Date.now(),
        recurring: data
      };
      sessionStorage.setItem(SESSION_KEY, JSON.stringify(cacheData));
    } catch (error) {
      console.warn('RecurringManager: Error saving session cache', error);
    }
  }

  /**
   * Load categories from active categories
   */
  function loadCategories() {
    console.log('RecurringManager: Loading categories...');
    
    try {
      // Try to get from localStorage first
      const cachedCategories = localStorage.getItem('simbudget_categories');
      const activeCategories = localStorage.getItem('simbudget_active_categories');
      
      if (cachedCategories && activeCategories) {
        const allCategories = JSON.parse(cachedCategories);
        const active = JSON.parse(activeCategories);
        
        _categories = allCategories
          .filter(cat => {
            const categoryName = typeof cat === 'string' ? cat : cat.name;
            return active.includes(categoryName);
          })
          .map(cat => {
            const categoryString = typeof cat === 'string' ? cat : cat.name || '';
            const parsed = parseCategoryNameAndEmoji(categoryString);
            return {
              id: parsed.name,
              name: parsed.name,
              emoji: parsed.emoji,
              fullName: categoryString
            };
          });
        
        console.log('RecurringManager: Loaded', _categories.length, 'active categories');
      }
    } catch (error) {
      console.warn('RecurringManager: Error loading categories', error);
      // Default categories fallback
      _categories = [
        {id: 'Subscription', name: 'Subscription', emoji: '📱', fullName: 'Subscription 📱'},
        {id: 'Utilities', name: 'Utilities', emoji: '💡', fullName: 'Utilities 💡'},
        {id: 'Insurance', name: 'Insurance', emoji: '🛡️', fullName: 'Insurance 🛡️'}
      ];
    }
  }

  /**
   * Parse category string to extract name and emoji
   */
  function parseCategoryNameAndEmoji(categoryString) {
    const parts = categoryString.trim().split(' ');
    
    if (parts.length >= 2) {
      const lastPart = parts[parts.length - 1];
      const emojiRegex = /[\u{1F600}-\u{1F6FF}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
      
      if (emojiRegex.test(lastPart)) {
        const name = parts.slice(0, -1).join(' ');
        const emoji = lastPart;
        return { name, emoji };
      }
    }
    
    return { name: categoryString, emoji: '' };
  }

  /**
   * Load real recurring data from API
   */
  function loadRealRecurringData(isBackgroundRefresh = false) {
    console.log('RecurringManager: Loading real data...');
    
    if (!isBackgroundRefresh) {
      showLoadingState();
    }
    
    if (!window.API || typeof API.getRecurringData !== 'function') {
      console.error('RecurringManager: API.getRecurringData not available');
      if (!isBackgroundRefresh) {
        showErrorState('API not available');
      }
      return;
    }

    API.getRecurringData(
      function(result) {
        console.log('RecurringManager: API success', result);
        
        if (result && result.success && result.recurring) {
          _recurringData = processRecurringData(result.recurring);
          saveToSessionCache(_recurringData);
          
          if (!isBackgroundRefresh) {
            renderRecurringView();
            bindEvents();
          } else {
            // Silent refresh - just update data and re-render
            updateSummaryCards();
            updateRecurringTable();
          }
          
          console.log('RecurringManager: Loaded', _recurringData.length, 'recurring items');
        } else {
          console.warn('RecurringManager: Invalid API response', result);
          if (!isBackgroundRefresh) {
            showErrorState(result?.error || 'Invalid response');
          }
        }
      },
      function(error) {
        console.error('RecurringManager: API error', error);
        if (!isBackgroundRefresh) {
          showErrorState(error);
        }
      }
    );
  }

  /**
   * Process raw recurring data from API
   */
  function processRecurringData(rawData) {
    console.log('RecurringManager: Processing', rawData.length, 'raw items');
    
    return rawData.map(item => {
      // Parse dates
      const startDate = item.startDate ? new Date(item.startDate) : null;
      const endDate = item.endDate ? new Date(item.endDate) : null;
      const nextPayment = item.nextPayment ? new Date(item.nextPayment) : null;
      
      return {
        id: item.id,
        rowIndex: item.rowIndex,
        startDate: startDate,
        endDate: endDate,
        name: item.name || '',
        category: item.category || '',
        type: item.type || '',
        frequency: item.frequency || 'Monthly',
        amount: parseFloat(item.amount) || 0,
        account: item.account || '',
        status: item.status || 'Active',
        nextPayment: nextPayment,
        notes: item.notes || ''
      };
    });
  }

  /**
   * Calculate banner metrics (Option A)
   */
  function calculateBannerMetrics() {
    const activeSubscriptions = _recurringData.filter(item => 
      item.status === 'Active' || item.status === 'active'
    );

    const activeCount = activeSubscriptions.length;
    
    // Calculate monthly average from all active subscriptions
    let monthlyTotal = 0;
    activeSubscriptions.forEach(item => {
      const freq = item.frequency.toLowerCase();
      const amount = item.amount;
      
      if (freq.includes('monthly')) {
        monthlyTotal += amount;
      } else if (freq.includes('yearly') || freq.includes('annual')) {
        monthlyTotal += amount / 12;
      } else if (freq.includes('quarterly')) {
        monthlyTotal += amount / 3;
      } else if (freq.includes('weekly')) {
        monthlyTotal += amount * 4.33; // Average weeks per month
      } else {
        // Default to monthly if unknown
        monthlyTotal += amount;
      }
    });

    // Annual projection
    const annualProjection = monthlyTotal * 12;
    
    // Budget Impact - get from current budget data if available
    let budgetImpact = 0;
    if (window._cache && typeof _cache.get === 'function') {
      const budgetData = _cache.get('budget');
      if (budgetData && budgetData.income) {
        const monthlyBudget = budgetData.income;
        budgetImpact = monthlyBudget > 0 ? (monthlyTotal / monthlyBudget) * 100 : 0;
      }
    }

    return {
      activeSubscriptions: activeCount,
      annualProjection: annualProjection,
      budgetImpact: budgetImpact,
      monthlyAverage: monthlyTotal
    };
  }

  /**
   * Show loading state
   */
  function showLoadingState() {
    const container = getElement('recurringContent');
    if (container) {
      container.innerHTML = `
        <div class="rec-loading">
          <div class="loading-spinner"></div>
          <p data-translate="loading_recurring">Loading recurring transactions...</p>
        </div>
      `;
    }
  }

  /**
   * Show error state
   */
  function showErrorState(error) {
    const container = getElement('recurringContent');
    if (container) {
      container.innerHTML = `
        <div class="rec-error">
          <h3 data-translate="error_loading_recurring">Error Loading Recurring Data</h3>
          <p>${error}</p>
          <button onclick="RecurringManager.refresh()" data-translate="retry">Retry</button>
        </div>
      `;
    }
  }

  /**
   * Render the complete recurring view
   */
  function renderRecurringView() {
    console.log('RecurringManager: Rendering view...');
    
    const container = getElement('recurringContent');
    if (!container) return;

    const metrics = calculateBannerMetrics();

    container.innerHTML = `
      <!-- Banner Cards -->
      <div class="rec-banner">
        <div class="rec-banner-card">
          <div class="rec-card-content">
            <div class="rec-metric">
              <div class="rec-metric-label" data-translate="active_subscriptions">Active Subscriptions</div>
              <div class="rec-metric-value" id="activeSubscriptionsCount">${metrics.activeSubscriptions}</div>
            </div>
            <div class="rec-metric">
              <div class="rec-metric-label" data-translate="annual_projection">Annual Projection</div>
              <div class="rec-metric-value" id="annualProjection">${formatCurrency(metrics.annualProjection)}</div>
            </div>
            <div class="rec-metric">
              <div class="rec-metric-label" data-translate="budget_impact">Budget Impact</div>
              <div class="rec-metric-value" id="budgetImpact">${metrics.budgetImpact.toFixed(1)}%</div>
            </div>
            <div class="rec-metric">
              <div class="rec-metric-label" data-translate="monthly_average">Monthly Average</div>
              <div class="rec-metric-value" id="monthlyAverage">${formatCurrency(metrics.monthlyAverage)}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recurring Table -->
      <div class="rec-table-section">
        <div class="rec-table-header">
          <h3 data-translate="my_subscriptions">My Subscriptions</h3>
          <div class="rec-table-actions">
            <button id="refreshRecurring" class="rec-refresh-btn" title="Refresh data">
              <i class="material-icons">refresh</i>
            </button>
          </div>
        </div>
        
        <div class="rec-table-container">
          <table class="rec-table" id="recurringTable">
            <thead>
              <tr>
                <th data-translate="name">Name</th>
                <th data-translate="category">Category</th>
                <th data-translate="frequency">Frequency</th>
                <th data-translate="amount">Amount</th>
                <th data-translate="status">Status</th>
                <th data-translate="next_payment">Next Payment</th>
                <th data-translate="account">Account</th>
                <th data-translate="actions">Actions</th>
              </tr>
            </thead>
            <tbody id="recurringTableBody">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    `;

    // Populate table
    updateRecurringTable();
  }

  /**
   * Update recurring table with current data
   */
  function updateRecurringTable() {
    const tbody = getElement('recurringTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    _recurringData.forEach(item => {
      const row = document.createElement('tr');
      row.setAttribute('data-id', item.id);
      
      // Determine status color
      let statusClass = 'status-active';
      if (item.status.toLowerCase().includes('expir')) {
        statusClass = 'status-expiring';
      } else if (item.status.toLowerCase().includes('end')) {
        statusClass = 'status-ended';
      }

      // Find category emoji
      const categoryInfo = _categories.find(cat => 
        cat.fullName === item.category || cat.name === item.category
      );
      const categoryEmoji = categoryInfo ? categoryInfo.emoji : '📄';

      // Format next payment date
      const nextPaymentStr = item.nextPayment ? 
        item.nextPayment.toLocaleDateString() : 'N/A';

      row.innerHTML = `
        <td class="rec-name-cell">
          <div class="rec-name-content">
            <span class="rec-item-name">${item.name}</span>
            <span class="rec-item-type">${item.type}</span>
          </div>
        </td>
        <td class="rec-category-cell">
          <span class="rec-category-emoji">${categoryEmoji}</span>
        </td>
        <td class="rec-frequency-cell">
          <span class="rec-frequency-full">${item.frequency}</span>
          <span class="rec-frequency-short">${item.frequency.charAt(0)}</span>
        </td>
        <td class="rec-amount-cell">
          <span class="rec-amount">${formatCurrency(item.amount)}</span>
        </td>
        <td class="rec-status-cell">
          <span class="rec-status ${statusClass}">${item.status}</span>
        </td>
        <td class="rec-next-payment-cell">${nextPaymentStr}</td>
        <td class="rec-account-cell">${item.account}</td>
        <td class="rec-actions-cell">
          <button class="rec-edit-btn" data-id="${item.id}" title="Edit">
            <i class="material-icons">edit</i>
          </button>
          <button class="rec-delete-btn" data-id="${item.id}" title="Delete">
            <i class="material-icons">delete</i>
          </button>
        </td>
      `;

      tbody.appendChild(row);
    });
  }

  /**
   * Update summary cards with current data
   */
  function updateSummaryCards() {
    const metrics = calculateBannerMetrics();
    
    const elements = {
      activeSubscriptionsCount: getElement('activeSubscriptionsCount'),
      annualProjection: getElement('annualProjection'),
      budgetImpact: getElement('budgetImpact'),
      monthlyAverage: getElement('monthlyAverage')
    };

    if (elements.activeSubscriptionsCount) {
      elements.activeSubscriptionsCount.textContent = metrics.activeSubscriptions;
    }
    if (elements.annualProjection) {
      elements.annualProjection.textContent = formatCurrency(metrics.annualProjection);
    }
    if (elements.budgetImpact) {
      elements.budgetImpact.textContent = metrics.budgetImpact.toFixed(1) + '%';
    }
    if (elements.monthlyAverage) {
      elements.monthlyAverage.textContent = formatCurrency(metrics.monthlyAverage);
    }
  }

  /**
   * Bind event listeners
   */
  function bindEvents() {
    console.log('RecurringManager: Binding events...');

    // Refresh button
    const refreshBtn = getElement('refreshRecurring');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        refresh();
      });
    }

    // Table action buttons - using event delegation
    const table = getElement('recurringTable');
    if (table) {
      table.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const itemId = button.getAttribute('data-id');
        if (!itemId) return;

        if (button.classList.contains('rec-edit-btn')) {
          editRecurringItem(itemId);
        } else if (button.classList.contains('rec-delete-btn')) {
          deleteRecurringItem(itemId);
        }
      });
    }

    // Currency change listener
    document.addEventListener('currency-changed', function(event) {
      _currencySymbol = event.detail.symbol;
      updateSummaryCards();
      updateRecurringTable();
    });
  }

  /**
   * Edit recurring item (placeholder for future implementation)
   */
  function editRecurringItem(itemId) {
    console.log('RecurringManager: Edit item', itemId);
    // TODO: Implement edit functionality
    if (window.Utils && Utils.showToast) {
      Utils.showToast('Edit functionality coming soon', 'info');
    }
  }

  /**
   * Delete recurring item
   */
  function deleteRecurringItem(itemId) {
    console.log('RecurringManager: Delete item', itemId);
    
    const item = _recurringData.find(r => r.id === itemId);
    if (!item) return;

    if (confirm(`Delete "${item.name}"?`)) {
      // Remove from UI immediately
      const row = document.querySelector(`tr[data-id="${itemId}"]`);
      if (row) row.remove();

      // Remove from local data
      _recurringData = _recurringData.filter(r => r.id !== itemId);
      
      // Update cache
      saveToSessionCache(_recurringData);
      
      // Update summary
      updateSummaryCards();

      // Clear on server
      if (window.API && typeof API.clearRecurringRow === 'function') {
        API.clearRecurringRow(itemId, 
          function(result) {
            console.log('RecurringManager: Item deleted on server');
          },
          function(error) {
            console.error('RecurringManager: Delete error', error);
          }
        );
      }
    }
  }

  /**
   * Refresh recurring data
   */
  function refresh() {
    console.log('RecurringManager: Manual refresh');
    
    // Clear session cache
    sessionStorage.removeItem(SESSION_KEY);
    
    // Reload data
    loadRealRecurringData();
  }

  /**
   * Set recurring data from external source
   */
  function setRecurringData(recurringData) {
    if (!recurringData || !Array.isArray(recurringData)) {
      console.warn('RecurringManager: Invalid recurring data');
      return;
    }

    _recurringData = processRecurringData(recurringData);
    saveToSessionCache(_recurringData);
    
    if (_initialized) {
      updateSummaryCards();
      updateRecurringTable();
    }
  }

  // Public API
  return {
    init: init,
    refresh: refresh,
    setRecurringData: setRecurringData
  };
})();

// Expose globally
window.RecurringManager = RecurringManager;
</script>



<style>
/* iOS-specific fix for date inputs - force full width */
input[type="date"].rec-edit-input {
  width: 100% !important;
  min-width: 100% !important;
  max-width: 100% !important;
  -webkit-appearance: none; /* Remove iOS default styling */
  appearance: none;
  display: block !important; /* Force block display */
}

/* Currency symbol regular positioning - more space for placeholder */
.rec-currency {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
  z-index: 1;
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

/* Move placeholder text far away from currency symbol */
.rec-amount {
  padding-left: 36px !important; /* Much larger padding */
  text-indent: 8px; /* Additional text indent for placeholder */
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

/* Dark mode support for date inputs */
body.dark-mode input[type="date"].rec-edit-input {
  background-color: var(--dark-surface, #1e1e1e);
  color: var(--dark-text-primary, rgba(255, 255, 255, 0.87));
}

/* More aggressive fix for amount placeholder position */
.rec-amount-wrapper {
  position: relative;
  width: 100%;
}

.rec-currency {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
  z-index: 1; /* Lower z-index so it doesn't overlap */
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

.rec-amount {
  padding-left: 36px !important; /* Much larger left padding */
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

/* Special styling for amount placeholder */
input[type="number"].rec-amount::placeholder {
  position: relative;
  z-index: 3;
}

/* ==============================================================
   RECURRING MANAGEMENT - DASHBOARD STYLE MATCHING
   ==============================================================
   All classes use the 'rec-' prefix to avoid conflicts.
   Mobile-first approach with desktop adjustments after.
   Matching dashboard's signature border style and color scheme.
*/

/* ======== NEW: FREQUENCY DISPLAY ON MOBILE ======== */
/* Hide the letter on desktop and full text on mobile */
.frequency-letter {
  display: none;
}

@media (max-width: 768px) {
  .frequency-full {
    display: none;
  }
  
  .frequency-letter {
    display: inline-block;
    font-weight: bold;
  }
  
  /* Make frequency cell narrower on mobile */
  .rec-frequency-cell,
  .rec-table th:nth-child(4) {
    width: 30px !important;
    max-width: 30px !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    text-align: center !important;
  }
}

/* ======== NEW: EMOJI-ONLY CATEGORY DISPLAY ======== */
.category-emoji-only {
  font-size: 16px !important;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  width: 100%;
}

/* Highlight the emoji when hovered */
.rec-category-cell:hover .category-emoji-only {
  transform: scale(1.1);
  transition: transform 0.2s ease;
}

/* Header styling for Category column */
.rec-table th:nth-child(3) {
  text-align: center !important;
  width: 40px !important;
}

/* Cell styling for Category column */
.rec-category-cell {
  text-align: center !important;
  width: 40px !important;
  cursor: help;
}

/* ======== LOADING & ERROR STATES ======== */
.rec-loading, .rec-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  text-align: center;
}

.rec-loading-text {
  margin-top: 16px;
  color: var(--text-secondary, #666);
}

.rec-error {
  background-color: #ffebee;
  border-radius: 0px;
  border-top: 1px solid rgba(0, 0, 0, 0.5);
  border-left: 1px solid rgba(0, 0, 0, 0.5);
  border-right: 4px solid #334a60;
  border-bottom: 4px solid #334a60;
}

.rec-error-details {
  font-family: monospace;
  background: rgba(0,0,0,0.05);
  padding: 8px;
  border-radius: 0px;
  max-width: 100%;
  overflow-x: auto;
  margin-top: 10px;
  font-size: 12px;
  color: #d32f2f;
}

/* ======== MESSAGES ======== */
.rec-message {
  padding: 12px 16px;
  border-radius: 0px;
  margin-bottom: 16px;
  font-weight: 500;
  border-top: 1px solid rgba(0, 0, 0, 0.5);
  border-left: 1px solid rgba(0, 0, 0, 0.5);
  border-right: 4px solid #334a60;
  border-bottom: 4px solid #334a60;
}

.rec-success-message {
  background-color: #e8f5e9;
  color: #2e7d32;
}

.rec-error-message {
  background-color: #ffebee;
  color: #d32f2f;
}

.rec-info-message {
  background-color: #e3f2fd;
  color: #1976d2;
}

/* ======== SUMMARY BOX ======== */
.rec-summary-row {
  margin-bottom: 16px;
  display: flex;
  justify-content: center;
}

.rec-summary-box {
  background-color: #fe9aa1; /* Match dashboard coral */
  border-radius: 0px;
  padding: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.5);
  border-left: 1px solid rgba(0, 0, 0, 0.5);
  border-right: 4px solid #334a60;
  border-bottom: 4px solid #334a60;
  width: 100%;
}

.rec-box-content {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}

.rec-box-item {
  flex: 1 0 calc(50% - 10px); /* Two columns on small screens */
  padding: 8px;
  text-align: center;
  margin-bottom: 5px;
}

.rec-box-label {
  font-size: 12px;
  color: black;
  margin-bottom: 4px;
  font-family: sans-serif;
}

.rec-box-value {
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

.rec-box-subtitle {
  font-size: 14px;
  color: #2c3e50;
  font-weight: normal;
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

/* Hide summary on mobile */
@media (max-width: 768px) {
  .rec-summary-row {
    display: none;
  }
}

/* Adjust Add Subscription button to match filter buttons but stand out */
.rec-add-subscription-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 0px;
  padding: 8px 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: background-color 0.2s;
  margin-left: 8px; /* Add spacing from the All button */
}

.rec-add-subscription-btn:hover {
  background-color: #1984c5;
}

.rec-add-subscription-btn i {
  font-size: 18px;
}

/* ======== TABLE SECTION ======== */
.rec-table-container {
  background-color: #ffffff;
  border-radius: 0px;
  padding: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.5);
  border-left: 1px solid rgba(0, 0, 0, 0.5);
  border-right: 4px solid #334a60;
  border-bottom: 4px solid #334a60;
}

.rec-table-header {
  display: flex;
  flex-direction: column;
  margin-bottom: 16px;
}

.rec-filters {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 8px;
}

.rec-status-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.rec-filter-btn {
  background-color: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 0px;
  padding: 8px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.rec-filter-btn.active {
  background-color: #2c3e50;
  color: white;
  border-color: #2c3e50;
}

.rec-filter-select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 0px;
  font-size: 14px;
}

.rec-table-wrapper {
  overflow-x: auto;
  margin-bottom: 16px;
}

.rec-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px; /* More compact for mobile */
}

.rec-table th,
.rec-table td {
  padding: 10px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

.rec-table th {
  font-weight: 500;
  color: #607d8b;
  white-space: nowrap;
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 10;
  font-family: 'Lato', sans-serif;
  font-weight: 700;
}

.rec-table tbody tr {
  transition: background-color 0.2s;
}

.rec-table tbody tr:hover {
  filter: brightness(0.95);
}

.rec-table tbody tr.rec-editing {
  box-shadow: 0 0 0 2px #2c3e50;
  position: relative;
  z-index: 5;
}

.rec-amount-cell {
  font-weight: 500;
  white-space: nowrap;
  font-family: 'Lato', sans-serif;
  font-weight: 700;
  color: #2c3e50;
}

.rec-action-btn {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  width: 36px;
  height: 36px;
  border-radius: 0px;
}

.rec-action-btn:hover {
  background-color: rgba(0,0,0,0.05);
  color: #2c3e50;
}

.rec-actions-cell {
  white-space: nowrap;
}

.rec-save-btn {
  color: #4caf50;
}

.rec-cancel-btn {
  color: #757575; /* Neutral gray color */
}

.rec-edit-input {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 0px;
  font-size: 14px;
}

.rec-input-error {
  border-color: #f44336 !important;
  background-color: rgba(244, 67, 54, 0.1) !important;
}

.rec-noneditable {
  color: #999;
  font-style: italic;
}

/* Mobile optimizations for table */
@media (max-width: 768px) {
  /* Use smaller text and padding in table */
  .rec-table {
    font-size: 12px;
  }
  
  .rec-table th,
  .rec-table td {
    padding: 6px 4px;
  }
  
  /* Fixed table wrapper CSS - no horizontal scrolling */
  .rec-table-wrapper {
    width: 100%;
    overflow-x: auto;
  }
  
  /* Hide start date, payment method and notes columns on mobile */
  .rec-startdate-cell,
  .rec-table th:nth-child(1),
  .rec-payment-cell,
  .rec-table th:nth-child(6),
  .rec-notes-cell,
  .rec-table th:nth-child(9) {
    display: none;
  }
  
  /* Name column */
  .rec-name-cell,
  .rec-table th:nth-child(2) {
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Frequency column */
  .rec-frequency-cell,
  .rec-table th:nth-child(4) {
    width: 60px;
    max-width: 60px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Amount column */
  .rec-amount-cell,
  .rec-table th:nth-child(5) {
    width: 50px;
    white-space: nowrap;
  }
  
  /* End date column */
  .rec-enddate-cell,
  .rec-table th:nth-child(7) {
    width: 70px;
    white-space: nowrap;
  }
  
  /* Next payment column */
  .rec-nextpayment-cell,
  .rec-table th:nth-child(8) {
    width: 70px;
    white-space: nowrap;
  }
  
  /* Actions column */
  .rec-actions-cell,
  .rec-table th:nth-child(10) {
    width: 36px;
    padding-left: 0;
    padding-right: 0;
  }
  
  /* Action button smaller */
  .rec-action-btn {
    width: 28px;
    height: 28px;
  }
  
  .rec-action-btn i {
    font-size: 18px;
  }
  
  /* Make material icons smaller on mobile */
  .rec-table .material-icons {
    font-size: 18px;
  }
  
  /* Filter adjustments for mobile */
  .rec-filter-btn {
    padding: 6px 8px;
    font-size: 11px;
  }
  
  /* Enhanced category column - bigger emoji on mobile */
  .category-emoji-only {
    font-size: 18px !important; /* Slightly larger on mobile */
  }
}

/* Sample table for fallback */
.rec-sample-table {
  width: 100%;
  overflow-x: auto;
  margin-top: 20px;
}

.rec-sample-table table {
  width: 100%;
  border-collapse: collapse;
}

.rec-sample-table th,
.rec-sample-table td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

/* ======== DARK MODE SUPPORT ======== */
/* Summary box becomes dark in dark mode like dashboard */
body.dark-mode .rec-summary-box {
  background-color: var(--dark-surface, #1e1e1e) !important;
  color: var(--dark-text-primary, rgba(255, 255, 255, 0.87)) !important;
}

/* White data containers stay dark */
body.dark-mode .rec-table-container,
body.dark-mode .rec-sample-table table {
  background-color: var(--dark-surface, #1e1e1e);
  color: var(--dark-text-primary, rgba(255, 255, 255, 0.87));
}

/* Labels and secondary text */
body.dark-mode .rec-box-label,
body.dark-mode .rec-table th {
  color: var(--dark-text-secondary, rgba(255, 255, 255, 0.6)) !important;
}

/* Values and important numbers - golden color like dashboard */
body.dark-mode .rec-box-value,
body.dark-mode .rec-box-subtitle,
body.dark-mode .rec-amount-cell {
  color: #DDA15E !important;
}

/* Currency symbols */
body.dark-mode .rec-currency {
  color: rgba(255, 255, 255, 0.6) !important;
}

/* Form elements */
body.dark-mode .rec-filter-select,
body.dark-mode .rec-filter-btn,
body.dark-mode .rec-edit-input {
  background-color: var(--dark-surface, #1e1e1e);
  color: var(--dark-text-primary, rgba(255, 255, 255, 0.87));
  border-color: var(--dark-border, rgba(255, 255, 255, 0.12));
}

/* Table styling */
body.dark-mode .rec-table td,
body.dark-mode .rec-sample-table td {
  border-color: var(--dark-border, rgba(255, 255, 255, 0.12));
}

body.dark-mode .rec-table th {
  background-color: var(--dark-surface, #1e1e1e);
}

/* Interactive elements */
body.dark-mode .rec-action-btn {
  color: var(--dark-text-secondary, rgba(255, 255, 255, 0.6));
}

body.dark-mode .rec-action-btn:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: #DDA15E;
}

/* Emoji cell - improved visibility in dark mode */
body.dark-mode .category-emoji-only {
  color: #ffffff !important;
  text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
}

/* Status row backgrounds */
body.dark-mode .rec-table tbody tr[data-status="Active"] {
  background-color: rgba(76, 175, 80, 0.15) !important; /* Darker green with transparency */
}

body.dark-mode .rec-table tbody tr[data-status="Expires"] {
  background-color: rgba(255, 152, 0, 0.15) !important; /* Darker yellow with transparency */
}

body.dark-mode .rec-table tbody tr[data-status="Ended"] {
  background-color: rgba(244, 67, 54, 0.15) !important; /* Darker red with transparency */
}

/* Filter button active state */
body.dark-mode .rec-filter-btn.active {
  background-color: #DDA15E;
  border-color: #DDA15E;
  color: #1e1e1e;
}

/* Add New Subscription button - dark mode style */
body.dark-mode .rec-add-subscription-btn {
  background-color: #DDA15E;
  color: #1e1e1e;
}

body.dark-mode .rec-add-subscription-btn:hover {
  background-color: #c9955a;
}

/* ======== DESKTOP STYLES ======== */
@media (min-width: 769px) {
  /* Improved summary layout */
  .rec-box-item {
    flex: 1; /* Equal width columns on desktop */
  }
  
  .rec-box-label {
    font-size: 14px;
  }
  
  .rec-box-value {
    font-size: 22px;
  }
  
  /* Improve filters layout */
  .rec-filters {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .rec-status-filters {
    flex: 3;
  }
  
  .rec-category-filter {
    flex: 1;
    max-width: 200px;
  }
  
  /* Show all table columns on desktop */
  .rec-table {
    font-size: 15px;
  }
  
  .rec-notes-header,
  .rec-notes-cell,
  .rec-frequency-cell,
  .rec-enddate-cell,
  .rec-payment-cell {
    display: table-cell;
  }
  
  /* Container width restrictions for larger screens */
  .rec-table-container,
  .rec-summary-box {
    margin-left: auto;
    margin-right: auto;
    max-width: 85%; /* Adjust width to match summary box */
  }
}

/* ======== PRINT STYLES ======== */
@media print {
  .rec-filters,
  .rec-action-btn {
    display: none !important;
  }
  
  .rec-summary-box,
  .rec-table-container {
    border: 1px solid #ccc !important;
    break-inside: avoid !important;
    margin-top: 20px !important;
  }
  
  .rec-table-wrapper {
    overflow: visible !important;
  }
  
  .rec-table th,
  .rec-table td {
    padding: 8px !important;
  }
  
  /* Show all columns when printing */
  .rec-notes-header,
  .rec-notes-cell,
  .rec-frequency-cell,
  .rec-enddate-cell,
  .rec-payment-cell {
    display: table-cell !important;
  }
}
</style>