<script>
  /**
   * Init.html - Initialization script for SimBudget
   * Handles application startup, event binding, and view management
   */

  // Main SimBudget namespace
  var SimBudget = (function () {
    // Private variables
    let _initialized = false;
    let _currentView = "expense";
    let _isRendering = false;
    let _loadingView = null;
    let _isLoadingExpenseView = false;

  
 


// Settings module - Updated to work with the new initialization
const Settings = {
  // Keep existing defaults
  defaults: {
    currencySymbol: "$",
    dateFormat: "MM/DD/YYYY",
    darkMode: false,
    showRemaining: true,
    enableAlerts: true,
    startingDay: "1",
    language: "en",
    showDecimals: true,
  },

  // Internal cache for loaded settings
  _cachedSettings: null,

  // Get a setting with fallback to default
  getSetting: function (key) {
    // Use cached settings if available (loaded during init)
    if (this._cachedSettings) {
      return this._cachedSettings[key] !== undefined ? this._cachedSettings[key] : this.defaults[key];
    }
    
    // Fallback to CacheManager
    const cached = CacheManager.getSettings();
    if (cached) {
      return cached[key] !== undefined ? cached[key] : this.defaults[key];
    }
    
    // Last resort: defaults
    return this.defaults[key];
  },

  // Set a single setting
  setSetting: function (key, value) {
    const settings = this.getAll();
    settings[key] = value;
    return this.saveAll(settings);
  },

  // Save all settings to server
  saveAll: function (settings) {
    // Update internal cache immediately
    this._cachedSettings = { ...settings };
    
    // Save to server
    API.setUserSettings(settings, 
      function() {
        // Success - update cache
        CacheManager.setSettings(settings);
        
        // Update all grid views with new currency
        if (window.MonthlyGrid) MonthlyGrid.updateCurrency();
        
        // Broadcast currency change to other components
        if (settings.currencySymbol) {
          document.dispatchEvent(new CustomEvent('currency-changed', {
            detail: { symbol: settings.currencySymbol }
          }));
        }
      },
      function(error) {
        console.error("Error saving settings to server:", error);
      }
    );
    return true;
  },

  // Get all settings (from cache or defaults)
  getAll: function () {
    // Use cached settings if available
    if (this._cachedSettings) {
      return { ...this._cachedSettings };
    }
    
    // Try CacheManager
    const cached = CacheManager.getSettings();
    if (cached) {
      this._cachedSettings = cached; // Cache it
      return { ...cached };
    }
    
    // Return defaults
    return { ...this.defaults };
  },

  // Fetch settings from server in the background
_fetchFromServer: function() {
  API.getUserSettings(
    function(result) {
      if (result && result.settings) {
        // Update cache
        CacheManager.setSettings(result.settings);
        
        // ONLY re-apply if settings actually changed
        const currentSettings = SimBudget.Settings.getAll();
        const hasChanged = JSON.stringify(currentSettings) !== JSON.stringify(result.settings);
        
        if (hasChanged) {
          SimBudget.applySettingsFromData(result.settings);
          
          // Force budget re-render if we're on budget view
          if (SimBudget.Views.getCurrent() === "budget") {
            const cachedData = window.CacheManager.getDashboardData();
            if (cachedData) {
              SimBudget.renderBudgetDashboard(cachedData);
            }
          }
        }
      }
    },
    function(error) {
      console.error("Error fetching settings from server:", error);
    }
  );
},

  // Keep convenience methods unchanged
  getCurrencySymbol: function () {
    return this.getSetting("currencySymbol");
  },

  getDateFormat: function () {
    return this.getSetting("dateFormat");
  },

  isDarkMode: function () {
    return this.getSetting("darkMode");
  },

  showDecimals: function () {
    return this.getSetting("showDecimals");
  },
};

    // View management
    const Views = {
      // Switch to a view
    
      switchTo: function (viewName) {
        if (!viewName) return;

        // Hide all views
        document.querySelectorAll(".view").forEach((view) => {
          view.classList.remove("active-view");
        });

        // Show the selected view
        const targetView = document.getElementById(viewName + "View");
        if (targetView) {
          targetView.classList.add("active-view");
          _currentView = viewName;

          // Update sidebar active state
          document.querySelectorAll(".sidebar-item").forEach((item) => {
            item.classList.remove("active");
          });

          const activeItem = document.querySelector(
            `.sidebar-item[data-view="${viewName}"]`
          );
          if (activeItem) {
            activeItem.classList.add("active");
          }

          // Dispatch event when view is activated
          const event = new CustomEvent("view-activated", {
            detail: { view: viewName },
          });
          document.dispatchEvent(event);

          // Load data for the view
          if (viewName === 'budget' && window.CacheManager && CacheManager.isValid('budget')) {
        // Budget view with valid cache - use cached data
        console.log('Using cached budget data');
        SimBudget.renderViewFromCache('budget');
      } else {
        // Any other view or invalid cache - load fresh data
        SimBudget.loadViewData(viewName);
}
        }
      },

      // Get current view
      getCurrent: function () {
        return _currentView;
      },
    };

    // Public methods
    return {
      // Settings module reference
      Settings: Settings,

      // Views module reference
      Views: Views,

   /**
 * Initialize the application - CLEAN VERSION: Settings load silently first
 */
initialize: function() {
  if (_initialized) return;

  // STEP 1: Load settings IMMEDIATELY and SILENTLY (no spinner)
  this.loadSettingsSync();

  // STEP 2: Continue with normal initialization (unchanged)
  sessionStorage.setItem('monthlyGrid_sessionActive', 'true');
  this.loadGlobalCategories();

  // Set up event listeners
  this.bindEvents();

  // Set up month and year selectors
  this.setupMonthYearSelectors();

  // Check for existing sheet URL
  this.checkExistingConnection();

  // Load user info
  this.loadUserInfo();

  // Load translations based on loaded language preference
  this.loadTranslations();

  // ENHANCED: Check for saved view and switch to it
  const savedView = this.getSavedView();
  
  if (savedView && this.isValidView(savedView)) {
    // Switch to saved view instead of default 'expense'
    this.Views.switchTo(savedView);
  } else {
    // Load default view data
    this.loadViewData("expense");
  }

  _initialized = true;
},

/**
 * Load settings synchronously and silently (no UI changes)
 */
loadSettingsSync: function() {
  // Try cache first
  const cached = CacheManager.getSettings();
  if (cached) {
    console.log('Using cached settings');
    this.applySettingsFromData(cached);
    return;
  }

  // If no cache, use defaults immediately (prevents flash)
  console.log('No cached settings, using defaults to prevent flash');
  this.applySettingsFromData(this.Settings.defaults);

  // Then load real settings in background (no UI blocking)
  setTimeout(() => {
    this.Settings._fetchFromServer();
  }, 100);
},

/**
 * Apply settings from data object (keep this from before)
 */
applySettingsFromData: function(settingsData) {
  // Apply dark mode if enabled
  if (settingsData.darkMode) {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }

  // Set values in settings form if they exist
  const currencyInput = document.getElementById("currencySymbol");
  if (currencyInput) {
    currencyInput.value = settingsData.currencySymbol || '$';
  }

  const dateFormatSelect = document.getElementById("dateFormat");
  if (dateFormatSelect) {
    dateFormatSelect.value = settingsData.dateFormat || 'MM/DD/YYYY';
  }

  const darkModeCheckbox = document.getElementById("darkMode");
  if (darkModeCheckbox) {
    darkModeCheckbox.checked = settingsData.darkMode || false;
  }

  const languageSelect = document.getElementById("languageSelector");
  if (languageSelect) {
    languageSelect.value = settingsData.language || 'en';
  }

  const showRemainingCheckbox = document.getElementById("showRemaining");
  if (showRemainingCheckbox) {
    showRemainingCheckbox.checked = settingsData.showRemaining !== false;
  }

  const enableAlertsCheckbox = document.getElementById("enableAlerts");
  if (enableAlertsCheckbox) {
    enableAlertsCheckbox.checked = settingsData.enableAlerts !== false;
  }

  const startingDaySelect = document.getElementById("startingDay");
  if (startingDaySelect) {
    startingDaySelect.value = settingsData.startingDay || "1";
  }

  const showDecimalsCheckbox = document.getElementById("showDecimals");
  if (showDecimalsCheckbox) {
    showDecimalsCheckbox.checked = settingsData.showDecimals !== false;
  }
},







/**
 * Apply settings from data object (not from Settings module)
 */
applySettingsFromData: function(settingsData) {
  console.log('SimBudget: Applying settings:', settingsData);
  
  // Apply dark mode if enabled
  if (settingsData.darkMode) {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }

  // Set values in settings form if they exist
  const currencyInput = document.getElementById("currencySymbol");
  if (currencyInput) {
    currencyInput.value = settingsData.currencySymbol || '$';
  }

  const dateFormatSelect = document.getElementById("dateFormat");
  if (dateFormatSelect) {
    dateFormatSelect.value = settingsData.dateFormat || 'MM/DD/YYYY';
  }

  const darkModeCheckbox = document.getElementById("darkMode");
  if (darkModeCheckbox) {
    darkModeCheckbox.checked = settingsData.darkMode || false;
  }

  const languageSelect = document.getElementById("languageSelector");
  if (languageSelect) {
    languageSelect.value = settingsData.language || 'en';
  }

  const showRemainingCheckbox = document.getElementById("showRemaining");
  if (showRemainingCheckbox) {
    showRemainingCheckbox.checked = settingsData.showRemaining !== false;
  }

  const enableAlertsCheckbox = document.getElementById("enableAlerts");
  if (enableAlertsCheckbox) {
    enableAlertsCheckbox.checked = settingsData.enableAlerts !== false;
  }

  const startingDaySelect = document.getElementById("startingDay");
  if (startingDaySelect) {
    startingDaySelect.value = settingsData.startingDay || "1";
  }

  const showDecimalsCheckbox = document.getElementById("showDecimals");
  if (showDecimalsCheckbox) {
    showDecimalsCheckbox.checked = settingsData.showDecimals !== false;
  }
  
  console.log('SimBudget: Settings applied successfully');
},




/**
 * Load categories globally so all views can use them
 */
loadGlobalCategories: function() {
  API.getCategoriesWithTimestamp(
    function(result) {
      if (result && result.success && result.categories) {
        // Store globally so MonthlyGrid can access them
        window._globalCategories = result.categories;
        console.log('Global categories loaded:', result.categories.length);
      }
    },
    function(error) {
      console.warn('Could not load global categories:', error);
      window._globalCategories = [];
    }
  );
},

/**
 * Get saved view from localStorage
 * @return {string|null} Saved view name or null
 */
getSavedView: function() {
  try {
    return localStorage.getItem('simbudget_lastActiveView');
  } catch (error) {
    console.warn("Session persistence: Could not read saved view", error);
    return null;
  }
},

/**
 * Validate if a view name is supported
 * @param {string} viewName - View name to validate
 * @return {boolean} True if valid view
 */
isValidView: function(viewName) {
  const validViews = ['budget', 'expense', 'income', 'recurring', 'netWorth', 'reports', 'categories', 'settings'];
  return validViews.includes(viewName);
},

// ENHANCED Views.switchTo function with session persistence
Views: {
  /**
   * Switch to a view - ENHANCED with session persistence
   */
  switchTo: function(viewName) {
  if (!viewName) return;

  // Store the current month/year before switching
  const fromView = _currentView;
  const toView = viewName;
  
  // Save the view choice for session persistence
  try {
    localStorage.setItem('simbudget_lastActiveView', viewName);
  } catch (error) {
    console.warn("Session persistence: Could not save active view", error);
  }

  // Hide all views
  document.querySelectorAll(".view").forEach((view) => {
    view.classList.remove("active-view");
  });


// ✅ CHECK FOR CATEGORY CHANGES WHEN SWITCHING TO EXPENSE VIEW
if (viewName === 'expense' && window.MonthlyGrid) {
  // Force category refresh when entering expense view
  // This catches any changes made while in other views
  setTimeout(() => {
    if (window.notifyMonthlyGridOfCategoryChange) {
      notifyMonthlyGridOfCategoryChange();
    }
  }, 100);
}

  // Show the selected view
  const targetView = document.getElementById(viewName + "View");
  if (targetView) {
    targetView.classList.add("active-view");
    _currentView = viewName;

    // Update sidebar active state
    this.updateSidebarActiveState(viewName);
    
   // SYNC MONTH/YEAR when switching between budget and expenses
// SYNC MONTH/YEAR when switching between budget and expenses
if (fromView === 'budget' && toView === 'expense') {
  if (window.MonthlyGrid && typeof _currentMonth !== 'undefined') {
    console.log('Syncing expense view to budget month:', _currentMonth, _currentYear);
       MonthlyGrid.setMonthYear(_currentMonth, _currentYear);
    MonthlyGrid.navigateToMonth(_currentMonth, _currentYear);
    // Store the month/year for MonthlyGrid to use
    window._pendingMonthSync = {
      month: _currentMonth,
      year: _currentYear
    };
    
    // Let loadExpenseData handle it when container is ready
  }
}
    
    // Dispatch event when view is activated
    const event = new CustomEvent("view-activated", {
      detail: { view: viewName }
    });
    document.dispatchEvent(event);

    // Load data for the view
    SimBudget.loadViewData(viewName);
  }
},

  /**
   * Update sidebar active state - NEW helper function
   * @param {string} viewName - Active view name
   */
  updateSidebarActiveState: function(viewName) {
    // Remove active class from all sidebar items
    document.querySelectorAll(".sb-nav-item").forEach((item) => {
      item.classList.remove("active");
    });

    // Add active class to current view
    const activeItem = document.querySelector(
      `.sb-nav-item[data-view="${viewName}"]`
    );
    if (activeItem) {
      activeItem.classList.add("active");
    } else {
      console.warn("Sidebar: Could not find nav item for", viewName);
    }
  },

  /**
   * Get current view
   */
  getCurrent: function() {
    return _currentView;
  }
},

      /**
       * Load translations based on user preference
       */
      loadTranslations: function () {
        const language = this.Settings.getSetting("language") || "en";

        API.getTranslations(
          language,
          function (result) {
            if (result && result.translations) {
              // Store translations globally
              window.SimBudget = window.SimBudget || {};
              SimBudget.translations = result.translations;

              // Apply translations to the UI
              SimBudget.applyTranslations();
            }
          },
          function (error) {
            console.error("Error loading translations:", error);
          }
        );
      },

      /**
       * Apply translations to UI elements
       */
      applyTranslations: function () {
        if (!SimBudget.translations) return;

        document.querySelectorAll("[data-translate]").forEach((el) => {
          const key = el.getAttribute("data-translate");
          if (key && SimBudget.translations[key]) {
            el.textContent = SimBudget.translations[key];
          }
        });

        document
          .querySelectorAll("[data-translate-placeholder]")
          .forEach((el) => {
            const key = el.getAttribute("data-translate-placeholder");
            if (key && SimBudget.translations[key]) {
              el.setAttribute("placeholder", SimBudget.translations[key]);
            }
          });

        document.querySelectorAll("[data-translate-title]").forEach((el) => {
          const key = el.getAttribute("data-translate-title");
          if (key && SimBudget.translations[key]) {
            el.setAttribute("title", SimBudget.translations[key]);
          }
        });

        if (this._currentBudgetData) {
          // Force update budget messages with translations
          this.updateInfoMessage(true);
        }
      },
      /**
       * Set up month and year selectors
       */
      setupMonthYearSelectors: function () {
        // YEAR SELECTOR - Add this first
        const yearSelector = document.getElementById("yearSelector");
        if (yearSelector) {
          // Clear existing options
          yearSelector.innerHTML = "";

          // Get current year
          const currentYear = new Date().getFullYear();

          // Create options for a range of years (current year ± 2)
          for (let year = currentYear - 2; year <= currentYear + 2; year++) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelector.appendChild(option);
          }

          // Set current year as selected
          yearSelector.value = currentYear.toString();
        }

        // MONTH SELECTOR - Keep your existing code
        const monthSelector = document.getElementById("monthSelector");
        if (monthSelector) {
          // Clear existing options
          monthSelector.innerHTML = "";

          // Month keys for translations
          const monthKeys = [
            "january",
            "february",
            "march",
            "april",
            "may",
            "june",
            "july",
            "august",
            "september",
            "october",
            "november",
            "december",
          ];

          // English month names (preserve for values)
          const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];

          // Get current month (0-11)
          const currentMonth = new Date().getMonth();

          // Create options for each month
          monthKeys.forEach((monthKey, index) => {
            const option = document.createElement("option");
            option.value = monthNames[index]; // Keep English values for backend compatibility
            option.setAttribute("data-translate", monthKey); // Enable translation
            option.textContent = monthNames[index]; // Default text
            monthSelector.appendChild(option);
          });

          // Set current month as selected
          monthSelector.value = monthNames[currentMonth];
        }
      },

            updateMonthYear: function (month, year) {
        if (_isRendering) return;
        if (_loadingView === true) return;  
        
        // Convert month name to month number (0-based)
        const monthNum = typeof month === 'string' ? 
          new Date(Date.parse(month + " 1, 2000")).getMonth() : month;
        
        // Update local state
        _currentMonth = monthNum;
        _currentYear = parseInt(year);
        
        // Update CacheManager
        if (window.CacheManager) {
          window.CacheManager.setCurrentMonth(monthNum, parseInt(year));
        }
        
        // SYNC: Update both budget selectors AND expense display
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        
        // Update budget selectors
        const monthSelector = document.getElementById("monthSelector");
        const yearSelector = document.getElementById("yearSelector");
        if (monthSelector) monthSelector.value = monthNames[monthNum];
        if (yearSelector) yearSelector.value = year.toString();
        
        // Update expense display
        const monthYearDisplay = document.getElementById('monthYearDisplay');
        if (monthYearDisplay) {
          const monthName = new Date(year, monthNum, 1).toLocaleString('default', { month: 'long' });
          monthYearDisplay.textContent = `${monthName} ${year}`;
        }
        
        // Load data for current view
        if (_currentView === 'budget') {
          this.loadBudgetData();
        } else if (_currentView === 'expense' && window.MonthlyGrid) {
          MonthlyGrid.setMonthYear(monthNum, parseInt(year));
          MonthlyGrid.refresh();
        }
      },


      /**
       * Bind all event listeners
       */
      bindEvents: function () {


          // Listen for category changes from any component
        document.addEventListener('categories-changed', function(event) {
          console.log('SimBudget: Categories changed event received:', event.detail);
          
          const currentView = SimBudget.Views.getCurrent();
          
          // If we're in expense view, immediately refresh the grid
          if (currentView === 'expense') {
            console.log('SimBudget: Currently in expense view, triggering immediate refresh');
            
            // Small delay to ensure CacheManager is fully updated
            setTimeout(() => {
              if (window.MonthlyGrid && typeof MonthlyGrid.refresh === 'function') {
                MonthlyGrid.refresh();
              }
            }, 100); // Reduced from 200ms since no UserProperties delay needed
          }
          
          // Update quick expense dropdown regardless of current view
          if (window.CategoriesManager && typeof CategoriesManager.updateQuickExpenseDropdown === 'function') {
            CategoriesManager.updateQuickExpenseDropdown();
          }
        });

        // Cross-tab communication listener for category changes
window.addEventListener('storage', function(e) {
  if (e.key === 'simbudget-categories-changed' && e.newValue) {
    try {
      const data = JSON.parse(e.newValue);
      console.log('Init: Received category change from another tab:', data);
      
      // Update CacheManager cache immediately
      if (window.CacheManager && data.categories) {
        const timestamp = new Date().toISOString();
        CacheManager.setCategoriesWithTimestamp(data.categories, timestamp);
      }
      
      // Update current view if it's categories
      if (SimBudget.Views.getCurrent() === 'categories' && window.CategoriesManager) {
        console.log('Init: Updating categories view from cross-tab change');
        CategoriesManager.init(); // Refresh categories view
      }
      
      // Update expense view if active
      if (SimBudget.Views.getCurrent() === 'expense' && window.MonthlyGrid) {
        console.log('Init: Updating expense grid from cross-tab change');
        MonthlyGrid.refresh();
      }
      
      // Update budget view if active
      if (SimBudget.Views.getCurrent() === 'budget') {
        console.log('Init: Updating budget view from cross-tab change');
        // Force dashboard refresh without server call
        const cachedData = CacheManager.getDashboardData();
        if (cachedData) {
          SimBudget.renderBudgetDashboard(cachedData);
        }
      }
      
    } catch (error) {
      console.error('Init: Error processing cross-tab category change:', error);
    }
  }
});


      // DESKTOP sidebar toggle with reliable event delegation 
      document.addEventListener("click", function(e) {
        // Debug what's actually being clicked
        const clickTarget = e.target.closest('#toggleSidebar');
        if (clickTarget) {
          
          const sidebar = document.getElementById("sidebar");
          const contentArea = document.getElementById("contentArea");
          
          if (sidebar) {
            sidebar.classList.toggle("sb-open");
            sidebar.classList.toggle("sb-collapsed");
            
            if (contentArea) {
              contentArea.classList.toggle("sb-expanded");
            }
          }
        }
      });

   // MONTH/YEAR SELECTORS - ATTACH TO DOCUMENT (NEVER FAILS!)
document.addEventListener("change", function(e) {
  // Only process if we're in budget view
  if (!document.getElementById('budgetView')?.classList.contains('active-view')) {
    return;
  }
  
  // Month selector
  if (e.target && e.target.id === "monthSelector") {
    console.log('Month changed to:', e.target.value);
    const yearSelector = document.getElementById("yearSelector");
    if (yearSelector) {
      SimBudget.updateMonthYear(e.target.value, yearSelector.value);
    }
  }
  
  // Year selector
  if (e.target && e.target.id === "yearSelector") {
    console.log('Year changed to:', e.target.value);
    const monthSelector = document.getElementById("monthSelector");
    if (monthSelector) {
      SimBudget.updateMonthYear(monthSelector.value, e.target.value);
    }
  }
});
  // Refresh recurring button
  const refreshRecurringBtn = document.getElementById("refreshRecurring");
  if (refreshRecurringBtn) {
    refreshRecurringBtn.addEventListener("click", () => {
      console.log("Manual refresh triggered for recurring");
      
      // Clear cache
      CacheManager.invalidate("recurring");
      
      // Call RecurringManager's refresh method
      if (window.RecurringManager && typeof RecurringManager.refresh === 'function') {
        RecurringManager.refresh();
      } else {
        // Fallback: reload the view
        this.loadViewData("recurring", true);
      }
    });
  }

  // Refresh categories
  const refreshCategoriesBtn = document.getElementById("refreshCategories");
  if (refreshCategoriesBtn) {
    refreshCategoriesBtn.addEventListener("click", () => {
      // Force refresh by invalidating cache
      if (
        window.CategoriesManager &&
        typeof CategoriesManager.refreshCategories === "function"
      ) {
        CategoriesManager.refreshCategories();
      } else {
        console.error(
          "Cannot refresh categories - CategoriesManager not available"
        );
        Utils.showToast("Cannot refresh categories", "error");
      }
    });
  }

  const refreshIncomeBtn = document.getElementById("refreshIncome");
  if (refreshIncomeBtn) {
    refreshIncomeBtn.addEventListener("click", () => {
      // Force refresh by invalidating cache
      CacheManager.invalidate("income");
      this.loadViewData("income", true);
    });
  }

  // Mobile sidebar toggle - Using event delegation for reliability
document.addEventListener("click", function(e) {
  if (e.target.closest('#mobileSidebarToggle')) {
    const mobileToggle = e.target.closest('#mobileSidebarToggle');
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("sidebarBackdrop");

    if (sidebar) {
      sidebar.classList.toggle("sb-open");

      if (backdrop) {
        backdrop.classList.toggle("sb-visible");
      }

      // Update toggle icon
      mobileToggle.innerHTML = sidebar.classList.contains("sb-open")
        ? '<i class="material-icons">close</i>'
        : '<i class="material-icons">menu</i>';

      // Lock/unlock body scroll
      document.body.style.overflow = sidebar.classList.contains("sb-open")
        ? "hidden"
        : "";
    }
  }
});
  // Sidebar navigation - FIXED to use sb-nav-item instead of sidebar-item
  document
    .querySelectorAll('.sb-nav-item, [data-view="settings"]')
    .forEach((item) => {
      item.addEventListener("click", function (e) {
        e.preventDefault();

        // Get the view name from data attribute
        const viewName = this.getAttribute("data-view");
        if (!viewName) return;

        // Update active state
        document.querySelectorAll(".sb-nav-item").forEach((navItem) => {
          navItem.classList.remove("active");
        });
        this.classList.add("active");

        // Switch to the view using SimBudget's existing function
        if (window.SimBudget && SimBudget.Views) {
          SimBudget.Views.switchTo(viewName);
        }

        // Close sidebar on mobile
        if (window.innerWidth < 992) {
          const sidebar = document.getElementById("sidebar");
          const backdrop = document.getElementById("sidebarBackdrop");
          const mobileToggle = document.getElementById(
            "mobileSidebarToggle"
          );

          if (sidebar) sidebar.classList.remove("sb-open");
          if (backdrop) backdrop.classList.remove("sb-visible");
          document.body.style.overflow = "";
          if (mobileToggle)
            mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
        }
      });

      // Also handle link clicks directly
      const link = item.querySelector("a");
      if (link) {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();

          // Trigger click on parent
          const navItem = this.closest(
            '.sb-nav-item, [data-view="settings"]'
          );
          if (navItem) navItem.click();
        });
      }
    });

  // Settings panel
  const saveSettingsBtn = document.getElementById("saveSettingsBtn");
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener("click", this.saveSettings);
  }

  const resetSettingsBtn = document.getElementById("resetSettings");
  if (resetSettingsBtn) {
    resetSettingsBtn.addEventListener("click", this.resetSettings);
  }

  const testConnectionBtn = document.getElementById("testConnection");
  if (testConnectionBtn) {
    testConnectionBtn.addEventListener("click", this.testConnection);
  }

  // Responsive design - auto-collapse sidebar on small screens
  window.addEventListener(
    "resize",
    Utils.debounce(function () {
      const sidebar = document.getElementById("sidebar");
      if (
        window.innerWidth < 768 &&
        sidebar &&
        sidebar.classList.contains("sb-open")
      ) {
        // Close sidebar
        sidebar.classList.remove("sb-open");

        const backdrop = document.getElementById("sidebarBackdrop");
        if (backdrop) backdrop.classList.remove("sb-visible");

        document.body.style.overflow = "";

        const mobileToggle = document.getElementById(
          "mobileSidebarToggle"
        );
        if (mobileToggle)
          mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
      }
    }, 250)
  );

  // Sidebar backdrop click handler
  const sidebarBackdrop = document.getElementById("sidebarBackdrop");
  if (sidebarBackdrop) {
    sidebarBackdrop.addEventListener("click", function () {
      const sidebar = document.getElementById("sidebar");
      if (sidebar) {
        sidebar.classList.remove("sb-open");
        this.classList.remove("sb-visible");
        document.body.style.overflow = "";

        const mobileToggle = document.getElementById(
          "mobileSidebarToggle"
        );
        if (mobileToggle)
          mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
      }
    });
  }

  // Set up view-specific buttons
  const refreshBudgetBtn = document.getElementById("refreshBudget");
  if (refreshBudgetBtn) {
    refreshBudgetBtn.addEventListener("click", () => {
      // Only clear the view cache, NOT the data!
      CacheManager.invalidate("budget");
      this.loadViewData("budget", true);
    });
  }

  const refreshNetWorthBtn = document.getElementById("refreshNetWorth");
  if (refreshNetWorthBtn) {
    refreshNetWorthBtn.addEventListener("click", () => {
      // Force refresh by invalidating cache
      CacheManager.invalidate("netWorth");
      this.loadViewData("netWorth", true);
    });
  }
},

      /**
       * Check for existing connection and load if available
       */
      checkExistingConnection: function () {
        API.getUserCredentials(
          function (result) {
            if (result.sheetUrl) {
              const urlInput = document.getElementById("budgetSheetUrl");
              if (urlInput) {
                urlInput.value = result.sheetUrl;
              }

              // Auto-test connection
              SimBudget.testConnection();
            }
          },
          function (error) {
            console.error("Error getting user credentials:", error);
          }
        );
      },

      /**
       * Apply user settings
       */
      applySettings: function () {
        const settings = Settings.getAll();

        // Apply dark mode if enabled
        if (settings.darkMode) {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        // Set values in settings form
        const currencyInput = document.getElementById("currencySymbol");
        if (currencyInput) {
          currencyInput.value = settings.currencySymbol;
        }

        const dateFormatSelect = document.getElementById("dateFormat");
        if (dateFormatSelect) {
          dateFormatSelect.value = settings.dateFormat;
        }

        const darkModeCheckbox = document.getElementById("darkMode");
        if (darkModeCheckbox) {
          darkModeCheckbox.checked = settings.darkMode;
        }

        const languageSelect = document.getElementById("languageSelector");
        if (languageSelect) {
          languageSelect.value = settings.language;
        }

        const showRemainingCheckbox = document.getElementById("showRemaining");
        if (showRemainingCheckbox) {
          showRemainingCheckbox.checked = settings.showRemaining;
        }

        const enableAlertsCheckbox = document.getElementById("enableAlerts");
        if (enableAlertsCheckbox) {
          enableAlertsCheckbox.checked = settings.enableAlerts;
        }

        const startingDaySelect = document.getElementById("startingDay");
        if (startingDaySelect) {
          startingDaySelect.value = settings.startingDay;
        }

        // In applySettings function
        const showDecimalsCheckbox = document.getElementById("showDecimals");
        if (showDecimalsCheckbox) {
          showDecimalsCheckbox.checked = settings.showDecimals;
        }
      },

      openSpreadsheet: function () {
        const urlInput = document.getElementById("budgetSheetUrl");
        if (urlInput && urlInput.value) {
          window.open(urlInput.value, "_blank");
        } else {
          Utils.showToast("No spreadsheet URL configured", "error");
        }
      },

      /**
       * Load user info
       */
      loadUserInfo: function () {
        API.getUserCredentials(
          function (result) {
            const userEmailEl = document.getElementById("userEmail");
            if (userEmailEl) {
              userEmailEl.textContent = result.email || "Not signed in";
            }
          },
          function (error) {
            console.error("Error getting user credentials:", error);
            const userEmailEl = document.getElementById("userEmail");
            if (userEmailEl) {
              userEmailEl.textContent = "Error loading user info";
            }
          }
        );
      },

      /**
       * Save settings
       */
            saveSettings: function () {
        // Get values from form
        const settings = {
          currencySymbol: document.getElementById("currencySymbol").value,
          dateFormat: document.getElementById("dateFormat").value,
          darkMode: document.getElementById("darkMode").checked,
          showRemaining: document.getElementById("showRemaining").checked,
          enableAlerts: document.getElementById("enableAlerts").checked,
          startingDay: document.getElementById("startingDay").value,
          language: document.getElementById("languageSelector").value,
          showDecimals: document.getElementById("showDecimals").checked,
        };
        
        // Save settings to server
        if (SimBudget.Settings.saveAll(settings)) {
          // Apply settings immediately
          SimBudget.applySettings();
          
          // Save sheet URL if provided - also server-side
          const sheetUrl = document.getElementById("budgetSheetUrl").value;
          if (sheetUrl) {
            API.setBudgetSheetUrl(
              sheetUrl,
              function () {
                Utils.showStatus(
                  "Settings saved successfully",
                  false,
                  document.getElementById("settingsStatus"),
                  3000
                );
                // Invalidate all caches when sheet URL changes
                CacheManager.invalidateAll();
              },
              function (error) {
                Utils.showStatus(
                  "Settings saved but sheet URL could not be saved: " + error,
                  true,
                  document.getElementById("settingsStatus")
                );
              }
            );
          } else {
            Utils.showStatus(
              "Settings saved successfully",
              false,
              document.getElementById("settingsStatus"),
              3000
            );
          }
        } else {
          Utils.showStatus(
            "Error saving settings",
            true,
            document.getElementById("settingsStatus")
          );
        }
      },

      /**
       * Reset settings to defaults
       */
      resetSettings: function () {
        // Reset to defaults
        if (SimBudget.Settings.saveAll(SimBudget.Settings.defaults)) {
          // Apply settings
          SimBudget.applySettings();

          Utils.showStatus(
            "Settings reset to defaults",
            false,
            document.getElementById("settingsStatus"),
            3000
          );
        } else {
          Utils.showStatus(
            "Error resetting settings",
            true,
            document.getElementById("settingsStatus")
          );
        }
      },

 testConnection: function () {
  const sheetUrl = document.getElementById("budgetSheetUrl").value;
  if (!sheetUrl) {
    Utils.showStatus(
      "Please enter a spreadsheet URL",
      true,
      document.getElementById("connectionStatus")
    );
    return;
  }

  // Show loading state
  Utils.showStatus(
    "Testing connection...",
    false,
    document.getElementById("connectionStatus")
  );

  API.verifySheetUrl(
    sheetUrl,
    function (result) {
      Utils.showStatus(
        "Connection successful!",
        false,
        document.getElementById("connectionStatus"),
        3000
      );

      // FIXED: Only clear cache if URL actually changed
      if (window._lastTestedUrl !== sheetUrl) {
        window._lastTestedUrl = sheetUrl;
        CacheManager.invalidateAll();
        console.log('CacheManager: Cache cleared due to spreadsheet URL change');
      } else {
        console.log('CacheManager: Same URL tested, keeping cache intact');
      }
    },
    function (error) {
      Utils.showStatus(
        "Connection failed: " + error,
        true,
        document.getElementById("connectionStatus")
      );
    }
  );
},

/**
 * Load data for a specific view with caching and preloading
 * @param {string} viewName - Name of the view to load
 * @param {boolean} forceRefresh - Whether to bypass cache and force a refresh
 */
loadViewData: function(viewName, forceRefresh = false) {
  // Skip if already loading the same view
  if (_loadingView === viewName && !forceRefresh) {
    return;
  }

  // Set loading flag
  _loadingView = viewName;

  // Categories now use smart timestamp caching
if (viewName === "categories") {
  console.log('Categories view: Using timestamp-based smart caching');
  this.loadCategoriesData();
  _loadingView = null;
  return;
}

  // CACHE-FIRST STRATEGY: Check cache first unless force refresh
  if (!forceRefresh && CacheManager.isValid(viewName)) {
    this.renderViewFromCache(viewName);
    _loadingView = null;
    
    // Start preloader if this is the first view and we're not in refresh mode
    if (!_preloader.isRunning && !CacheManager.areAllPriorityViewsLoaded()) {
      CacheManager.startPreloader(viewName);
    }
    return;
  }

  // Load from server for all other views
  switch (viewName) {
    case "budget":
      this.loadBudgetData();
      break;
    case "expense":
      this.loadExpenseData();
      break;
    case "income":
      this.loadIncomeData();
      break;
    case "recurring":
      this.loadRecurringData();
      break;
    case "netWorth":
      this.loadNetWorthData();
      break;
    case "reports":
      this.loadReportsSheet();
      break;
    case "settings":
      _loadingView = null; 
      break;
    default:
      console.error(`LoadViewData: Unknown view ${viewName}`);
      _loadingView = null;
  }
},


/**
 * Load categories data - UPDATED to use timestamp system only
 */
loadCategoriesData: function () {
  console.log('Init: Loading categories data...');
  
  const contentArea = document.getElementById("categoriesContent");
  if (!contentArea) {
    console.error("Categories content area not found");
    _loadingView = null;
    return;
  }

  let categoriesContainer = document.getElementById("categories-container");
  if (!categoriesContainer) {
    categoriesContainer = document.createElement("div");
    categoriesContainer.id = "categories-container";
    categoriesContainer.className = "categories-container";
    contentArea.appendChild(categoriesContainer);
  }

  // Check if CategoriesManager is already initialized
  if (window.CategoriesManager && 
      typeof CategoriesManager.isInitialized === 'function' && 
      CategoriesManager.isInitialized()) {
    console.log("Init: CategoriesManager already initialized, skipping load");
    _loadingView = null;
    return;
  }

  // Show loading state
  categoriesContainer.innerHTML = 
    '<div class="categories-loading"><div class="loading-spinner"></div><p>Loading categories...</p></div>';

  // Initialize CategoriesManager with timestamp system
  if (window.CategoriesManager && typeof CategoriesManager.init === 'function') {
    console.log('Init: Initializing CategoriesManager with timestamp system...');
    
    try {
      CategoriesManager.init(); // This now uses loadCategoriesWithTimestamp()
      console.log('Init: CategoriesManager initialized successfully');
      _loadingView = null;
    } catch (error) {
      console.error('Init: Error initializing CategoriesManager:', error);
      categoriesContainer.innerHTML = `
        <div class="categories-error">
          <i class="material-icons">error</i>
          <p>Error loading categories: ${error}</p>
          <button onclick="SimBudget.loadCategoriesData()" class="retry-btn">Retry</button>
        </div>
      `;
      _loadingView = null;
    }
  } else {
    console.error('Init: CategoriesManager not available');
    categoriesContainer.innerHTML = `
      <div class="categories-error">
        <i class="material-icons">error</i>
        <p>CategoriesManager component not found</p>
      </div>
    `;
    _loadingView = null;
  }
},

   /**
 * Render view using cached data
 * @param {string} viewName - Name of the view to render
 */
renderViewFromCache: function (viewName) {
  console.log(`Rendering ${viewName} view from cache`);
  
  
  // Categories now use timestamp-based caching
  if (viewName === "categories") {
    console.log('Categories view: Using timestamp-based cache system');
    this.loadCategoriesData();
    return;
  }
  
  // For all other views, check cache
  const cachedData = CacheManager.get(viewName);

  if (!cachedData) {
    console.error(`No cached data found for ${viewName} view`);
    return;
  }

  switch (viewName) {
    case "budget":
      this.loadBudgetData(false); // Don't force refresh - use cache
      break;
    case "expense":
      this.loadExpenseData();
      break;
    case "income":
      this.loadIncomeData(); // Just load it - no special render yet
      break;
    case "recurring":
      this.loadRecurringData(); // Load with cache support
      break;
    case "netWorth":
      this.loadNetWorthData(); // Load placeholder
      break;
    case "reports":
      this.loadReportsSheet(); // Load placeholder
      break;
    default:
      console.error(`Unknown view name for cache rendering: ${viewName}`);
  }
},

/**
 * Load budget data - CLEAN VERSION with timestamp caching and no delays
 * UPDATED: Uses CacheManager.loadBudgetDataWithTimestamp() and removes setTimeout delays
 */
loadBudgetData: function(forceRefresh = false) {
  if (typeof _currentMonth === 'undefined') {
    _currentMonth = new Date().getMonth();
    _currentYear = new Date().getFullYear();
  }
  
  const contentArea = document.getElementById("budgetContent");
  
  // Check cache ONLY if not forcing refresh
  if (!forceRefresh) {
    const cachedData = window.CacheManager.get(`dashboard_${_currentYear}-${_currentMonth}`);
    if (cachedData) {
      SimBudget.renderBudgetDashboard(cachedData);
      CacheManager.set('budget', cachedData);
      _loadingView = null;
      return;
    }
  }

  // Show loading overlay
  if (contentArea) {
    const existingDashboard = contentArea.querySelector('.dashboard-container');
    if (existingDashboard) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.9);z-index:100;';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      contentArea.style.position = 'relative';
      contentArea.appendChild(overlay);
    } else {
      contentArea.innerHTML = '<div style="padding:40px;text-align:center;"><div class="loading-spinner"></div><p>Loading budget data...</p></div>';
    }
  }

  // Clear caches if forcing refresh
  if (forceRefresh && window.CacheManager) {
    CacheManager.invalidate('budgetData');
    CacheManager.invalidate('dashboardData');
    CacheManager.clearMonth(_currentMonth, _currentYear);
  }
  
  // Load required data - NO MORE TIMEOUTS!
  let expensesLoaded = false;
  let budgetLoaded = false;
  let categoriesLoaded = false;
  let expensesData = null;
  let budgetData = null;
  let categoriesData = null;

  const checkAndRender = () => {
    if (expensesLoaded && budgetLoaded && categoriesLoaded) {
      try {
        // Store in cache
        if (expensesData) {
          window.CacheManager.setExpenses(expensesData, _currentMonth, _currentYear);
        }
        if (budgetData) {
          window.CacheManager.setBudgetData(budgetData);
        }
        
        // Calculate dashboard data
        const dashboardData = window.CacheManager.calculateDashboardData(
          expensesData || [], 
          categoriesData || [],
          _currentMonth, 
          _currentYear
        );
        
        if (dashboardData) {
          SimBudget.renderBudgetDashboard(dashboardData);
          CacheManager.set(`dashboard_${_currentYear}-${_currentMonth}`, dashboardData);
        } else {
          console.error('FAILED to calculate dashboard data');
          const contentArea = document.getElementById("budgetContent");
          const overlay = contentArea?.querySelector('.loading-overlay');
          if (overlay) overlay.remove();
        }
        
      } catch (error) {
        console.error('ERROR in checkAndRender:', error);
        const contentArea = document.getElementById("budgetContent");
        const overlay = contentArea?.querySelector('.loading-overlay');
        if (overlay) overlay.remove();
      }
      
      _loadingView = null;
    }
  };
  
  // 1. Load categories immediately (fast from UserProperties)
  API.getCategoriesWithTimestamp(
    function(result) {
      categoriesData = (result && result.categories) ? result.categories : [];
      categoriesLoaded = true;
      checkAndRender();
    },
    function(error) {
      console.error('Categories error:', error);
      categoriesData = [];
      categoriesLoaded = true;
      checkAndRender();
    }
  );
  
  // 2. Load budget data using timestamp caching - NO TIMEOUT!
  if (forceRefresh) {
    // Force fresh data
    CacheManager.fetchFreshBudgetData()
      .then(data => {
        budgetData = data || {};
        budgetLoaded = true;
        checkAndRender();
      })
      .catch(error => {
        console.error('Budget error:', error);
        budgetData = {};
        budgetLoaded = true;
        checkAndRender();
      });
  } else {
    // Use smart caching
    CacheManager.loadBudgetDataWithTimestamp()
      .then(data => {
        budgetData = data || {};
        budgetLoaded = true;
        checkAndRender();
      })
      .catch(error => {
        console.error('Budget error:', error);
        budgetData = {};
        budgetLoaded = true;
        checkAndRender();
      });
  }
  
  // 3. Load expenses - NO TIMEOUT!
  API.getExpenseData(_currentMonth, _currentYear,
    function(result) {
      expensesData = result.expenses || [];
      expensesLoaded = true;
      checkAndRender();
    },
    function(error) {
      console.error('Expenses error:', error);
      expensesData = [];
      expensesLoaded = true;
      checkAndRender();
    }
  );
},
  



      /**
       * This function remains in init.html even though it's referenced from dashboard.js
       * to maintain original scope access to _currentBudgetData
       */
      updateInfoMessage: function (force = false) {
        if (!this._currentBudgetData) return;

        const el =
          document.getElementById("budget-alert") ||
          document.getElementById("budget-info-message") ||
          document.querySelector(".budget-alert");
        if (!el) return;

        const budget = this._currentBudgetData;
        const totalBudgeted = budget.categories.reduce(
          (sum, cat) =>
            sum + (typeof cat.budgeted === "number" ? cat.budgeted : 0),
          0
        );

        // Determine message type and parameters
        let key,
          msgClass = "info";
        const formatted = Utils.formatCurrency(totalBudgeted);

        if (!budget.income) {
          key = "budget_no_income_tip";
          el.setAttribute("data-param1", formatted);
        } else if (Math.abs(budget.income - totalBudgeted) < 0.01) {
          key = "budget_perfect_match";
          el.setAttribute("data-param1", formatted);
          msgClass = "success";
        } else if (budget.income > totalBudgeted) {
          key = "budget_under_income";
          el.setAttribute("data-param1", formatted);
          el.setAttribute(
            "data-param2",
            Utils.formatCurrency(budget.income - totalBudgeted)
          );
        } else {
          key = "budget_over_income";
          el.setAttribute("data-param1", formatted);
          el.setAttribute(
            "data-param2",
            Utils.formatCurrency(totalBudgeted - budget.income)
          );
          msgClass = "warning";
        }

        // Set translation attributes
        el.setAttribute("data-translate", key);

        // Set initial text content using current translations if available
        if (SimBudget.translations && SimBudget.translations[key]) {
          const params = [
            el.getAttribute("data-param1"),
            el.getAttribute("data-param2"),
          ].filter(Boolean);
          el.textContent = Utils.formatTranslation(
            SimBudget.translations[key],
            params
          );
        }

        // Update class and ensure visibility
        el.className =
          (el.classList.contains("budget-alert")
            ? "budget-alert"
            : "info-message") +
          " " +
          msgClass;
        el.style.display = "block";
      },

      /**
       * Load expense data with reliable grid rendering
       * Always shows the grid with sample data first, then updates with real data if available
       */
      loadExpenseData: function () {

        const contentArea = document.getElementById("expenseContent");
        if (!contentArea) {
          console.error("Expense content area not found");
          _loadingView = null;
          return;
        }

        // 1. FIRST create a clean container with unique ID and proper dimensions
        const containerId = "expense-grid-" + Date.now();
        contentArea.innerHTML = `
        <div id="${containerId}" class="monthly-grid-container" 
            style="width:100%; height:100%; position:relative; overflow:auto;">
        </div>
      `;

        if (window.MonthlyGrid) {
          MonthlyGrid.init(containerId);
          

            // Check for pending month sync
            if (window._pendingMonthSync) {
              MonthlyGrid.setMonthYear(_pendingMonthSync.month, _pendingMonthSync.year);
              delete window._pendingMonthSync;
            }

           if (window.CacheManager && typeof _currentMonth !== 'undefined') {
           window.CacheManager.setCurrentMonth(_currentMonth, _currentYear);
             }

          // 3. FINALLY (optionally) fetch real data
          //    Grid is already visible, so this is non-blocking
          if (window.API && typeof API.getExpenseData === "function") {
            console.log("Fetching real expense data...");

            // Show subtle loading indicator
            const loadingIndicator = document.createElement("div");
            loadingIndicator.style.position = "absolute";
            loadingIndicator.style.top = "10px";
            loadingIndicator.style.right = "10px";
            loadingIndicator.style.background = "rgba(255,255,255,0.8)";
            loadingIndicator.style.padding = "5px 10px";
            loadingIndicator.style.borderRadius = "4px";
            loadingIndicator.style.fontSize = "12px";
            loadingIndicator.innerHTML = "Loading data...";
            document.getElementById(containerId).appendChild(loadingIndicator);

            API.getExpenseData(
              function (result) {
                console.log("Real expense data loaded successfully");

                // Update grid with real data if available
                if (result && result.success && result.expenses) {
                  MonthlyGrid.setExpenseData(result.expenses);
                }

                // Cache the result
                CacheManager.set("expense", result.expenses || []);

                // Remove loading indicator
                loadingIndicator.remove();
              },
              function (error) {
                console.log(
                  "Using sample data - couldn't load real data:",
                  error
                );

                // Update loading indicator to show info message
                loadingIndicator.style.background = "rgba(255, 248, 225, 0.9)";
                loadingIndicator.style.border = "1px solid #FFE082";
                loadingIndicator.innerHTML = "Using sample data";

                // Make indicator disappear after 3 seconds
                setTimeout(function () {
                  loadingIndicator.style.opacity = "0";
                  loadingIndicator.style.transition = "opacity 0.5s";

                  // Remove from DOM after fade out
                  setTimeout(function () {
                    loadingIndicator.remove();
                  }, 500);
                }, 3000);
              }
            );
          }
        } else {
          contentArea.innerHTML =
            '<div class="error-message">Error: Grid component not available</div>';
          console.error("MonthlyGrid component not found");
        }

        // Clear loading flag
        _loadingView = null;
      },
   
   
   
   
   
    // PRELOADER CONTROLS
  startPreloader: function(excludeView) {
    CacheManager.startPreloader(excludeView);
  },

  stopPreloader: function() {
    _preloader.stop();
  },

  getCacheStats: function() {
    return CacheManager.getStats();
  },

  // CACHE CONTROLS  
  clearCache: function() {
    CacheManager.invalidateAll();
    console.log("Manual cache clear completed");
  },

  // ENHANCED: Clear cache and reload current view
  refreshCurrentView: function() {
    const currentView = this.Views.getCurrent();
    console.log(`Refreshing current view: ${currentView}`);
    
    // Clear cache for current view and related views
    CacheManager.invalidateRelated(currentView);
    
    // Stop any running preloader
    _preloader.stop();
    
    // Reload current view with force refresh
    this.loadViewData(currentView, true);
  },
  


    loadExpenseData: function() {
  // Prevent multiple simultaneous loads
  if (_isLoadingExpenseView) {
    console.log('Already loading expense view, skipping');
    return;
  }
  
  _isLoadingExpenseView = true;
  
  const contentArea = document.getElementById("expenseContent");
  if (!contentArea) {
    console.error("Expense content area not found");
    _loadingView = null;
    return;
  }

  const containerId = "expense-grid-" + Date.now();
  contentArea.innerHTML = `
    <div id="${containerId}" class="monthly-grid-container" 
         style="width:100%; height:100%; position:relative; overflow:auto;">
    </div>
  `;


  
  if (window.MonthlyGrid) {
    // TELL MonthlyGrid not to clear cache when coming from budget
    if (SimBudget.Views.getCurrent() === 'budget') {
      window._skipCacheClear = true;
    }
    MonthlyGrid.init(containerId);

     // CHECK CACHE FIRST - if we have data, use it!
    const cachedExpenses = CacheManager.getExpenses(_currentMonth, _currentYear);
    if (cachedExpenses && cachedExpenses.length > 0) {
      console.log('Using cached expenses from CacheManager');
      MonthlyGrid.setExpenseData(cachedExpenses);
    }
    
    // FORCE MonthlyGrid to use the app's current month/year
    if (typeof _currentMonth !== 'undefined' && typeof _currentYear !== 'undefined') {
      MonthlyGrid.setMonthYear(_currentMonth, _currentYear);
    }
  }
  
  _loadingView = null;
},
   

// SIMPLIFIED VIEW LOADING: Just trigger preloader once per session
// REPLACE these functions in SimBudget return object:

/**
 * Load income data (stub with one-time preloader trigger)
 */
loadIncomeData: function() {
  console.log("LoadIncomeData: Income view not implemented yet");
  
  const contentArea = document.getElementById("incomeContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Income Management Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  CacheManager.startPreloader('income');
},


/**
 * Enhanced loadRecurringData function for Init.html
 * Properly uses cache system
 */
loadRecurringData: function() {
  console.log("Loading recurring view...");
  
  const contentArea = document.getElementById("recurringContent");
  if (!contentArea) {
    console.error("Recurring content area not found");
    _loadingView = null;
    return;
  }

  try {
    // Check if RecurringManager exists
    if (!window.RecurringManager || typeof RecurringManager.init !== 'function') {
      throw new Error("RecurringManager component not found");
    }

    // Check cache first
    const cachedData = CacheManager.get('recurring');
    
    if (cachedData && Array.isArray(cachedData)) {
      console.log("Using cached recurring data:", cachedData.length, "items");
      // Initialize with cached data
      RecurringManager.init('recurringContent', cachedData);
    } else {
      console.log("No cached recurring data, loading fresh");
      // Initialize without data - will load fresh
      RecurringManager.init('recurringContent', null);
    }
    
  } catch (err) {
    console.error("Error initializing RecurringManager:", err);
    contentArea.innerHTML = `
      <div class="error-message">
        <h3>Error Loading Recurring Module</h3>
        <p>${err.message}</p>
      </div>
    `;
  } finally {
    _loadingView = null;
  }
},

/**
 * Load net worth data (stub with one-time preloader trigger)
 */
loadNetWorthData: function() {
  
  const contentArea = document.getElementById("netWorthContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Net Worth Tracking Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  // SIMPLIFIED: Just try to start preloader - it handles session logic internally
  CacheManager.startPreloader('netWorth');
},

/**
 * Load reports data (stub with one-time preloader trigger)
 */
loadReportsSheet: function() {
  
  const contentArea = document.getElementById("reportsContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Financial Reports Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  // SIMPLIFIED: Just try to start preloader - it handles session logic internally
  CacheManager.startPreloader('reports');
},





 };
  })();

  // Make debug functions available globally for testing
  window.SimBudgetDebug = {
    /**
     * Force reload budget data from server
     */
    reloadBudget: function () {
      console.log("Debug: Force reloading budget data");
      SimBudget.loadBudgetData();
    },

    /**
     * Clear the cache and reload
     */
    clearCache: function () {
      console.log("Debug: Clearing cache");
      if (window.CacheManager && typeof window.CacheManager.invalidateAll === "function") {
        window.CacheManager.invalidateAll();
        console.log("Cache cleared");
      } else {
        console.log("Global cache not available");
      }
    },

    /**
     * Check current structure and log it
     */
    checkData: function () {
      console.log("Current budget data:", SimBudget._currentBudgetData);

      if (window.CacheManager && typeof window.CacheManager.get === "function") {
        console.log("Cached budget data:", window.CacheManager.get("budget"));
      } else {
        console.log("Cache is not accessible");
      }
    },

    /**
     * Test API connection
     */
    testConnection: function () {
      console.log("Testing API connection...");
      API.testServerConnection(
        function (result) {
          console.log("API Connection successful:", result);
        },
        function (error) {
          console.error("API Connection failed:", error);
        }
      );
    },
  };

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof SimBudget !== "undefined") {
      SimBudget.initialize();
    } else {
      console.error("SimBudget object not found. Initialization failed.");
    }
  });

// Add this to the SimBudget.initialize function in Init.html
// Coordinate cache invalidation with MonthlyGrid component
document.addEventListener('monthlyGrid-cache-cleared', function(event) {
  console.log('Received cache clear event from MonthlyGrid:', event.detail);
  
  // Clear SimBudget's expense cache
  if (window.CacheManager && typeof CacheManager.invalidate === 'function') {
    console.log('Clearing SimBudget application cache for expenses');
    CacheManager.invalidate('expense');
    
    // If currently in expense view, reload it
    if (SimBudget.Views.getCurrent() === 'expense') {
      console.log('Currently in expense view, triggering reload');
      // Use setTimeout to avoid potential race conditions
      setTimeout(function() {
        SimBudget.loadViewData('expense', true);
      }, 100);
    }
  }
});


  // Expose global cache for debugging
  // removed - using CacheManager

  // In Init.html - Add this to your initialization function
  document.addEventListener("language-changed", function () {
    // Refresh category displays
    if (
      window.CategoriesManager &&
      typeof CategoriesManager.renderCategories === "function"
    ) {
      CategoriesManager.renderCategories();
    }

    // Refresh quick expense dropdown
    if (
      window.QuickExpenseEntry &&
      typeof QuickExpenseEntry.updateCategoriesDropdown === "function"
    ) {
      QuickExpenseEntry.updateCategoriesDropdown();
    }

    // Refresh budget table if visible
    if (
      SimBudget._currentView === "budget" &&
      typeof SimBudget.renderBudgetDashboard === "function"
    ) {
      SimBudget.loadViewData("budget", true);
    }
  });

  // In settings.js.html - Dispatch event when language changes
  function changeLanguage(langCode) {
    // Existing code...

    // Dispatch language change event
    document.dispatchEvent(new CustomEvent("language-changed"));
  }
</script>
