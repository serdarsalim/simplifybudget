<script>
  /**
   * Init.html - Initialization script for SimBudget
   * Handles application startup, event binding, and view management
   */

  // Main SimBudget namespace
  var SimBudget = (function () {
    // Private variables
    let _initialized = false;
    let _currentView = "expense";
    let _isRendering = false;
    let _loadingView = null;

    // Cache system for data
    // STEP 1: Replace the existing _cache object in Init.html with this enhanced version

const _cache = {
  // Cache storage with data and metadata
  data: {
    budget: { content: null, timestamp: null },
    expense: { content: null, timestamp: null },
    income: { content: null, timestamp: null },
    recurring: { content: null, timestamp: null },
    netWorth: { content: null, timestamp: null },
    reports: { content: null, timestamp: null },
  },

  // Cache configuration
  config: {
    // Default cache expiry time in milliseconds (5 minutes)
    expiryTime: 24 * 60 * 60 * 1000, 
    // Flags to determine if certain actions should invalidate cache
    invalidateOnMonthYearChange: true,
    // Preloader settings
    preloadDelay: 1000, // Wait 1 second before preloading
    preloadInterval: 2000, // 2 seconds between preloads
  },

  // Store data in cache
  set: function (key, data) {
    if (!this.data[key]) return false;

    this.data[key].content = data;
    this.data[key].timestamp = new Date().getTime();
    return true;
  },

  // Get data from cache if valid
  get: function (key) {
    const cacheEntry = this.data[key];
    if (!cacheEntry || !cacheEntry.content) return null;

  const now = new Date().getTime();
  if (now - cacheEntry.timestamp > this.config.expiryTime) {
    return null;
   }


    return cacheEntry.content;
  },

  // Check if cache for key is valid
  isValid: function (key) {
    return this.get(key) !== null;
  },

  // Invalidate specific cache entries
  invalidate: function (key) {
    if (_isRendering) {
      return;
    }

    if (key && this.data[key]) {
      this.data[key].content = null;
      this.data[key].timestamp = null;
    }
  },

  // Invalidate all cache entries
  invalidateAll: function () {
    if (_isRendering) {
      return;
    }

    Object.keys(this.data).forEach((key) => {
      this.invalidate(key);
    });
  },

  // Invalidate related caches when a type of data is modified
  invalidateRelated: function (key) {
    if (_isRendering) {
      return;
    }

    // Define relationships between data types
    const relationships = {
      budget: ["reports"],
      expense: ["budget", "reports"],
      income: ["budget", "reports"],
      recurring: ["reports"],
      netWorth: ["reports"],
    };

    // Invalidate the primary key
    this.invalidate(key);

    // Invalidate related keys
    if (relationships[key]) {
      relationships[key].forEach((relatedKey) => {
        this.invalidate(relatedKey);
      });
    }
  },

  // NEW: Check if all priority views are loaded
  areAllPriorityViewsLoaded: function() {
    const priorityViews = ['budget', 'expense', 'income', 'recurring', 'netWorth'];
    return priorityViews.every(view => this.isValid(view));
  },

  // NEW: Get cache statistics
  getStats: function() {
    const stats = {};
    Object.keys(this.data).forEach(key => {
      stats[key] = {
        loaded: !!this.data[key].content,
        timestamp: this.data[key].timestamp,
        age: this.data[key].timestamp ? Date.now() - this.data[key].timestamp : null
      };
    });
    return stats;
  }
};

// STEP 2: Add this new _preloader object after the _cache object in Init.html

const _preloader = {
  queue: ['budget', 'expense', 'income', 'recurring', 'netWorth'],
  isRunning: false,
  currentIndex: 0,
  retryCount: {},
  hasRunInSession: false, // NEW: Track if preloader ran in this session

  start: function(excludeView) {
    // CRITICAL: Only allow one preload attempt per session
    if (this.hasRunInSession) {
      return;
    }

    if (this.isRunning) {
      return;
    }

    // Mark that we've attempted preloading in this session
    this.hasRunInSession = true;

    // Remove the current view from preload queue
    this.queue = this.queue.filter(view => view !== excludeView);
    console.log(`Preloader: Starting background load (SESSION START), excluded ${excludeView}`, this.queue);

    this.isRunning = true;
    this.currentIndex = 0;
    
    // Start after delay to let initial view fully load
    setTimeout(() => {
      this.processNext();
    }, _cache.config.preloadDelay);
  },

   processNext: function() {
    if (this.currentIndex >= this.queue.length) {
      console.log('Preloader: Completed all background loads - SESSION COMPLETE');
      this.isRunning = false;
      console.log('Cache Stats:', _cache.getStats());
      return;
    }

    const viewName = this.queue[this.currentIndex];
    
    // Skip if already cached
    if (_cache.isValid(viewName)) {
      this.currentIndex++;
      setTimeout(() => this.processNext(), 200);
      return;
    }

    console.log(`Preloader: Loading ${viewName} in background`);
    this.loadView(viewName);
  },

  loadView: function(viewName) {
    switch (viewName) {
      case 'budget':
        this.loadBudgetData(viewName);
        break;
      case 'expense':
        this.loadExpenseData(viewName);
        break;
      case 'income':
        this.loadIncomeData(viewName);
        break;
      case 'recurring':
        this.loadRecurringData(viewName);
        break;
      case 'netWorth':
        this.loadNetWorthData(viewName);
        break;
      default:
        console.log(`Preloader: Unknown view ${viewName}`);
        this.onComplete(viewName, false);
    }
  },

 loadBudgetData: function(viewName) {
    API.getDashboardData(
      (result) => {
        _cache.set('budget', result.dashboardData);
        this.onComplete(viewName, true);
      },
      (error) => {
        console.warn(`Preloader: Failed to load ${viewName}:`, error);
        this.onComplete(viewName, false);
      }
    );
  },

 loadExpenseData: function(viewName) {
    API.getExpenseData(
      (result) => {
        _cache.set('expense', result.expenses || []);
        this.onComplete(viewName, true);
      },
      (error) => {
        console.warn(`Preloader: Failed to load ${viewName}:`, error);
        this.onComplete(viewName, false);
      }
    );
  },



  loadIncomeData: function(viewName) {
    // TODO: Implement when income API is ready
    this.onComplete(viewName, false);
  },

  loadRecurringData: function(viewName) {
    // TODO: Implement when recurring API is ready
    this.onComplete(viewName, false);
  },

  loadNetWorthData: function(viewName) {
    // TODO: Implement when net worth API is ready
    this.onComplete(viewName, false);
  },

  onComplete: function(viewName, success) {
    if (success) {
      console.log(`Preloader: Successfully cached ${viewName}`);
    } else {
      // Track retry count
      this.retryCount[viewName] = (this.retryCount[viewName] || 0) + 1;
      
      // Retry if less than 3 attempts
      if (this.retryCount[viewName] < 3) {
        // Re-add to end of queue for retry
        this.queue.push(viewName);
      }
    }

    // Move to next item
    this.currentIndex++;
    setTimeout(() => this.processNext(), _cache.config.preloadInterval);
  },

  stop: function() {
    console.log('Preloader: Stopping background load');
    this.isRunning = false;
  }
};

    // Event management for month/year selectors
    const _eventManager = {
      // Event handler references
      handlers: {
        month: null,
        year: null,
      },

      // Detach event listeners
      detach: function () {
        const monthSelector = document.getElementById("monthSelector");
        const yearSelector = document.getElementById("yearSelector");

        if (monthSelector && this.handlers.month) {
          monthSelector.removeEventListener("change", this.handlers.month);
        }

        if (yearSelector && this.handlers.year) {
          yearSelector.removeEventListener("change", this.handlers.year);
        }
      },

      // Attach event listeners
      attach: function () {
        const monthSelector = document.getElementById("monthSelector");
        const yearSelector = document.getElementById("yearSelector");

        if (monthSelector && this.handlers.month) {
          monthSelector.addEventListener("change", this.handlers.month);
          console.log("Month change event attached");
        }

        if (yearSelector && this.handlers.year) {
          yearSelector.addEventListener("change", this.handlers.year);
          console.log("Year change event attached");
        }
      },
    };

        // Settings module
      const Settings = {
        // Default settings
        defaults: {
          currencySymbol: "$",
          dateFormat: "MM/DD/YYYY",
          darkMode: false,
          showRemaining: true,
          enableAlerts: true,
          startingDay: "1",
          language: "en",
          showDecimals: true,
        },

     
          // Get a setting with fallback to default
          getSetting: function (key) {
            // From cached settings or default
            const settings = this.getAll();
            return settings[key] !== undefined ? settings[key] : this.defaults[key];
          },

          // Set a single setting
          setSetting: function (key, value) {
            const settings = this.getAll();
            settings[key] = value;
            return this.saveAll(settings);
          },

          // Save all settings to server
        saveAll: function (settings) {
          // After successful save to server
          API.setUserSettings(settings, 
            function() {
              // Success - apply changes immediately
              Settings._cachedSettings = settings;
              
              // Update all grid views with new currency
              if (window.MonthlyGrid) MonthlyGrid.updateCurrency();
              
              // NEW: Broadcast currency change to other components
              if (settings.currencySymbol) {
                // Dispatch a custom event that other components can listen for
                document.dispatchEvent(new CustomEvent('currency-changed', {
                  detail: { symbol: settings.currencySymbol }
                }));
              }
            },
            function(error) {
              console.error("Error saving settings to server:", error);
            }
          );
          return true;
        },

          // Get all settings (from memory cache or defaults)
          getAll: function () {
            // If we have cached settings, use them
            if (this._cachedSettings) {
              return this._cachedSettings;
            }
            
            // Otherwise use defaults and trigger server fetch for next time
            this._fetchFromServer();
            return { ...this.defaults };
          },

        // Fetch settings from server in the background
        _fetchFromServer: function() {
          API.getUserSettings(
            function(result) {
              if (result && result.settings) {
                // Cache the server settings
                Settings._cachedSettings = result.settings;
                
                // If settings view is active, apply the settings to the form
                if (SimBudget.Views.getCurrent() === "settings") {
                  SimBudget.applySettings();
                }
              }
            },
            function(error) {
              console.error("Error fetching settings from server:", error);
            }
          );
        },

      // Cache for settings
        _cachedSettings: null,

      // Convenience methods for common settings
      getCurrencySymbol: function () {
        return this.getSetting("currencySymbol");
      },

      getDateFormat: function () {
        return this.getSetting("dateFormat");
      },

      isDarkMode: function () {
        return this.getSetting("darkMode");
      },

      showDecimals: function () {
        return this.getSetting("showDecimals");
      },
    };

    // View management
    const Views = {
      // Switch to a view
      // Switch to a view
      // Switch to a view
      switchTo: function (viewName) {
        if (!viewName) return;

        // Hide all views
        document.querySelectorAll(".view").forEach((view) => {
          view.classList.remove("active-view");
        });

        // Show the selected view
        const targetView = document.getElementById(viewName + "View");
        if (targetView) {
          targetView.classList.add("active-view");
          _currentView = viewName;

          // Update sidebar active state
          document.querySelectorAll(".sidebar-item").forEach((item) => {
            item.classList.remove("active");
          });

          const activeItem = document.querySelector(
            `.sidebar-item[data-view="${viewName}"]`
          );
          if (activeItem) {
            activeItem.classList.add("active");
          }

          // Dispatch event when view is activated
          const event = new CustomEvent("view-activated", {
            detail: { view: viewName },
          });
          document.dispatchEvent(event);

          // Load data for the view
          if (viewName === 'budget' && window._cache && _cache.isValid('budget')) {
        // Budget view with valid cache - use cached data
        console.log('Using cached budget data');
        SimBudget.renderViewFromCache('budget');
      } else {
        // Any other view or invalid cache - load fresh data
        SimBudget.loadViewData(viewName);
}
        }
      },

      // Get current view
      getCurrent: function () {
        return _currentView;
      },
    };

    // Public methods
    return {
      // Settings module reference
      Settings: Settings,

      // Views module reference
      Views: Views,

      /**
       * Initialize the application
       */
      // Replace these two functions in Init.html

/**
 * Initialize the application - ENHANCED with session persistence
 */
initialize: function() {
  if (_initialized) return;

  

  // Set up event listeners
  this.bindEvents();

  // Set up month and year selectors
  this.setupMonthYearSelectors();



  // Check for existing sheet URL
  this.checkExistingConnection();

  // Apply settings
  this.applySettings();

  // Load user info
  this.loadUserInfo();

  // Load translations based on saved language preference
  this.loadTranslations();

  // ENHANCED: Check for saved view and switch to it
  const savedView = this.getSavedView();
  
  if (savedView && this.isValidView(savedView)) {
    // Switch to saved view instead of default 'expense'
    this.Views.switchTo(savedView);
  } else {
    // Load default view data
    this.loadViewData("expense");
  }

  _initialized = true;
},

/**
 * Get saved view from localStorage
 * @return {string|null} Saved view name or null
 */
getSavedView: function() {
  try {
    return localStorage.getItem('simbudget_lastActiveView');
  } catch (error) {
    console.warn("Session persistence: Could not read saved view", error);
    return null;
  }
},

/**
 * Validate if a view name is supported
 * @param {string} viewName - View name to validate
 * @return {boolean} True if valid view
 */
isValidView: function(viewName) {
  const validViews = ['budget', 'expense', 'income', 'recurring', 'netWorth', 'reports', 'categories', 'settings'];
  return validViews.includes(viewName);
},

// ENHANCED Views.switchTo function with session persistence
Views: {
  /**
   * Switch to a view - ENHANCED with session persistence
   */
  switchTo: function(viewName) {
    if (!viewName) return;


    // Save the view choice for session persistence
    try {
      localStorage.setItem('simbudget_lastActiveView', viewName);
    } catch (error) {
      console.warn("Session persistence: Could not save active view", error);
    }

    // Hide all views
    document.querySelectorAll(".view").forEach((view) => {
      view.classList.remove("active-view");
    });

    // Show the selected view
    const targetView = document.getElementById(viewName + "View");
    if (targetView) {
      targetView.classList.add("active-view");
      _currentView = viewName;

      // Update sidebar active state - ENHANCED for reliability
      this.updateSidebarActiveState(viewName);

      
      // Dispatch event when view is activated
      const event = new CustomEvent("view-activated", {
        detail: { view: viewName },
      });
      document.dispatchEvent(event);

      // Load data for the view
      SimBudget.loadViewData(viewName);


    } else {
      console.error("Views.switchTo: Target view not found", viewName + "View");
    }
  },

  /**
   * Update sidebar active state - NEW helper function
   * @param {string} viewName - Active view name
   */
  updateSidebarActiveState: function(viewName) {
    // Remove active class from all sidebar items
    document.querySelectorAll(".sb-nav-item").forEach((item) => {
      item.classList.remove("active");
    });

    // Add active class to current view
    const activeItem = document.querySelector(
      `.sb-nav-item[data-view="${viewName}"]`
    );
    if (activeItem) {
      activeItem.classList.add("active");
    } else {
      console.warn("Sidebar: Could not find nav item for", viewName);
    }
  },

  /**
   * Get current view
   */
  getCurrent: function() {
    return _currentView;
  }
},

      /**
       * Load translations based on user preference
       */
      loadTranslations: function () {
        const language = this.Settings.getSetting("language") || "en";

        API.getTranslations(
          language,
          function (result) {
            if (result && result.translations) {
              // Store translations globally
              window.SimBudget = window.SimBudget || {};
              SimBudget.translations = result.translations;

              // Apply translations to the UI
              SimBudget.applyTranslations();
            }
          },
          function (error) {
            console.error("Error loading translations:", error);
          }
        );
      },

      /**
       * Apply translations to UI elements
       */
      applyTranslations: function () {
        if (!SimBudget.translations) return;

        document.querySelectorAll("[data-translate]").forEach((el) => {
          const key = el.getAttribute("data-translate");
          if (key && SimBudget.translations[key]) {
            el.textContent = SimBudget.translations[key];
          }
        });

        document
          .querySelectorAll("[data-translate-placeholder]")
          .forEach((el) => {
            const key = el.getAttribute("data-translate-placeholder");
            if (key && SimBudget.translations[key]) {
              el.setAttribute("placeholder", SimBudget.translations[key]);
            }
          });

        document.querySelectorAll("[data-translate-title]").forEach((el) => {
          const key = el.getAttribute("data-translate-title");
          if (key && SimBudget.translations[key]) {
            el.setAttribute("title", SimBudget.translations[key]);
          }
        });

        if (this._currentBudgetData) {
          // Force update budget messages with translations
          this.updateInfoMessage(true);
        }
      },
      /**
       * Set up month and year selectors
       */
      setupMonthYearSelectors: function () {
        // YEAR SELECTOR - Add this first
        const yearSelector = document.getElementById("yearSelector");
        if (yearSelector) {
          // Clear existing options
          yearSelector.innerHTML = "";

          // Get current year
          const currentYear = new Date().getFullYear();

          // Create options for a range of years (current year ± 2)
          for (let year = currentYear - 2; year <= currentYear + 2; year++) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelector.appendChild(option);
          }

          // Set current year as selected
          yearSelector.value = currentYear.toString();
        }

        // MONTH SELECTOR - Keep your existing code
        const monthSelector = document.getElementById("monthSelector");
        if (monthSelector) {
          // Clear existing options
          monthSelector.innerHTML = "";

          // Month keys for translations
          const monthKeys = [
            "january",
            "february",
            "march",
            "april",
            "may",
            "june",
            "july",
            "august",
            "september",
            "october",
            "november",
            "december",
          ];

          // English month names (preserve for values)
          const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];

          // Get current month (0-11)
          const currentMonth = new Date().getMonth();

          // Create options for each month
          monthKeys.forEach((monthKey, index) => {
            const option = document.createElement("option");
            option.value = monthNames[index]; // Keep English values for backend compatibility
            option.setAttribute("data-translate", monthKey); // Enable translation
            option.textContent = monthNames[index]; // Default text
            monthSelector.appendChild(option);
          });

          // Set current month as selected
          monthSelector.value = monthNames[currentMonth];
        }
      },

      /**
       * Update month and year when changed by user
       */
      updateMonthYear: function (month, year) {
      if (_isRendering) return;
      if (_loadingView) return;

      console.log(`Updating month/year to ${month} ${year}`);
      
      // ADD THIS:
      if (window.CacheManager) {
        // Convert month name to month number (0-based)
        const monthNum = new Date(Date.parse(month + " 1, 2000")).getMonth();
        window.CacheManager.setCurrentMonth(monthNum, parseInt(year));
      }
      
      API.setMonthYear(month, year,
        function (result) {
          // Existing code...
        },
        function (error) {
          // Existing code...
        }
      );
    },

      /**
       * Bind all event listeners
       */
      /**
       * Bind all event listeners
       */
      bindEvents: function () {
        // Sidebar toggle
        const toggleBtn = document.getElementById("toggleSidebar");
        if (toggleBtn) {
          toggleBtn.addEventListener("click", function () {
            const sidebar = document.getElementById("sidebar");
            const contentArea = document.getElementById("contentArea");

            const expensesBtn = document.getElementById("expenses-btn");
            if (expensesBtn) {
              expensesBtn.addEventListener("click", function () {
                SimBudget.Views.activate("expense");
              });
            }

            if (sidebar) {
              sidebar.classList.toggle("sb-open");
              sidebar.classList.toggle("sb-collapsed");

              if (contentArea) {
                contentArea.classList.toggle("sb-expanded");
              }
            }
          });
        }

       // In Init.html bindEvents function, update the refreshRecurringBtn handler:

const refreshRecurringBtn = document.getElementById("refreshRecurring");
if (refreshRecurringBtn) {
  refreshRecurringBtn.addEventListener("click", () => {
    console.log("Manual refresh triggered for recurring");
    
    // Clear cache
    _cache.invalidate("recurring");
    
    // Call RecurringManager's refresh method
    if (window.RecurringManager && typeof RecurringManager.refresh === 'function') {
      RecurringManager.refresh();
    } else {
      // Fallback: reload the view
      this.loadViewData("recurring", true);
    }
  });
}

        //refresh categories

        const refreshCategoriesBtn =
          document.getElementById("refreshCategories");
        if (refreshCategoriesBtn) {
          refreshCategoriesBtn.addEventListener("click", () => {
            // Force refresh by invalidating cache
            if (
              window.CategoriesManager &&
              typeof CategoriesManager.refreshCategories === "function"
            ) {
              CategoriesManager.refreshCategories();
            } else {
              console.error(
                "Cannot refresh categories - CategoriesManager not available"
              );
              Utils.showToast("Cannot refresh categories", "error");
            }
          });
        }

        const refreshIncomeBtn = document.getElementById("refreshIncome");
        if (refreshIncomeBtn) {
          refreshIncomeBtn.addEventListener("click", () => {
            // Force refresh by invalidating cache
            _cache.invalidate("income");
            this.loadViewData("income", true);
          });
        }

        // Mobile sidebar toggle
        const mobileToggle = document.getElementById("mobileSidebarToggle");
        if (mobileToggle) {
          mobileToggle.addEventListener("click", function () {
            const sidebar = document.getElementById("sidebar");
            const backdrop = document.getElementById("sidebarBackdrop");

            if (sidebar) {
              sidebar.classList.toggle("sb-open");

              if (backdrop) {
                backdrop.classList.toggle("sb-visible");
              }

              // Update toggle icon
              this.innerHTML = sidebar.classList.contains("sb-open")
                ? '<i class="material-icons">close</i>'
                : '<i class="material-icons">menu</i>';

              // Lock/unlock body scroll
              document.body.style.overflow = sidebar.classList.contains(
                "sb-open"
              )
                ? "hidden"
                : "";
            }
          });
        }

        // Sidebar navigation - FIXED to use sb-nav-item instead of sidebar-item
        document
          .querySelectorAll('.sb-nav-item, [data-view="settings"]')
          .forEach((item) => {
            item.addEventListener("click", function (e) {
              e.preventDefault();

              // Get the view name from data attribute
              const viewName = this.getAttribute("data-view");
              if (!viewName) return;

              // Update active state
              document.querySelectorAll(".sb-nav-item").forEach((navItem) => {
                navItem.classList.remove("active");
              });
              this.classList.add("active");

              // Switch to the view using SimBudget's existing function
              if (window.SimBudget && SimBudget.Views) {
                SimBudget.Views.switchTo(viewName);
              }

              // Close sidebar on mobile
              if (window.innerWidth < 992) {
                const sidebar = document.getElementById("sidebar");
                const backdrop = document.getElementById("sidebarBackdrop");
                const mobileToggle = document.getElementById(
                  "mobileSidebarToggle"
                );

                if (sidebar) sidebar.classList.remove("sb-open");
                if (backdrop) backdrop.classList.remove("sb-visible");
                document.body.style.overflow = "";
                if (mobileToggle)
                  mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
              }
            });

            // Also handle link clicks directly
            const link = item.querySelector("a");
            if (link) {
              link.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                // Trigger click on parent
                const navItem = this.closest(
                  '.sb-nav-item, [data-view="settings"]'
                );
                if (navItem) navItem.click();
              });
            }
          });

        // Month and year selectors
        const monthSelector = document.getElementById("monthSelector");
        const yearSelector = document.getElementById("yearSelector");

        if (monthSelector && yearSelector) {
          // Create handlers and store references
          _eventManager.handlers.month = function () {
            SimBudget.updateMonthYear(this.value, yearSelector.value);
          };

          _eventManager.handlers.year = function () {
            SimBudget.updateMonthYear(monthSelector.value, this.value);
          };

          // Initial attachment
          monthSelector.addEventListener(
            "change",
            _eventManager.handlers.month
          );
          yearSelector.addEventListener("change", _eventManager.handlers.year);
        }

        // Settings panel
        const saveSettingsBtn = document.getElementById("saveSettingsBtn");
        if (saveSettingsBtn) {
          saveSettingsBtn.addEventListener("click", this.saveSettings);
        }

        const resetSettingsBtn = document.getElementById("resetSettings");
        if (resetSettingsBtn) {
          resetSettingsBtn.addEventListener("click", this.resetSettings);
        }

        const testConnectionBtn = document.getElementById("testConnection");
        if (testConnectionBtn) {
          testConnectionBtn.addEventListener("click", this.testConnection);
        }

        // Responsive design - auto-collapse sidebar on small screens
        window.addEventListener(
          "resize",
          Utils.debounce(function () {
            const sidebar = document.getElementById("sidebar");
            if (
              window.innerWidth < 768 &&
              sidebar &&
              sidebar.classList.contains("sb-open")
            ) {
              // Close sidebar
              sidebar.classList.remove("sb-open");

              const backdrop = document.getElementById("sidebarBackdrop");
              if (backdrop) backdrop.classList.remove("sb-visible");

              document.body.style.overflow = "";

              const mobileToggle = document.getElementById(
                "mobileSidebarToggle"
              );
              if (mobileToggle)
                mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
            }
          }, 250)
        );

        // Add this to the bindEvents function in your Init.html file
        // Sidebar backdrop click handler
        const sidebarBackdrop = document.getElementById("sidebarBackdrop");
        if (sidebarBackdrop) {
          sidebarBackdrop.addEventListener("click", function () {
            const sidebar = document.getElementById("sidebar");
            if (sidebar) {
              sidebar.classList.remove("sb-open");
              this.classList.remove("sb-visible");
              document.body.style.overflow = "";

              const mobileToggle = document.getElementById(
                "mobileSidebarToggle"
              );
              if (mobileToggle)
                mobileToggle.innerHTML = '<i class="material-icons">menu</i>';
            }
          });
        }

        // Set up view-specific buttons
        const refreshBudgetBtn = document.getElementById("refreshBudget");
        if (refreshBudgetBtn) {
          refreshBudgetBtn.addEventListener("click", () => {
            // Force refresh by invalidating cache
            _cache.invalidate("budget");
            this.loadViewData("budget", true);
          });
        }

        const refreshNetWorthBtn = document.getElementById("refreshNetWorth");
        if (refreshNetWorthBtn) {
          refreshNetWorthBtn.addEventListener("click", () => {
            // Force refresh by invalidating cache
            _cache.invalidate("netWorth");
            this.loadViewData("netWorth", true);
          });
        }
      },

      /**
       * Check for existing connection and load if available
       */
      checkExistingConnection: function () {
        API.getUserCredentials(
          function (result) {
            if (result.sheetUrl) {
              const urlInput = document.getElementById("budgetSheetUrl");
              if (urlInput) {
                urlInput.value = result.sheetUrl;
              }

              // Auto-test connection
              SimBudget.testConnection();
            }
          },
          function (error) {
            console.error("Error getting user credentials:", error);
          }
        );
      },

      /**
       * Apply user settings
       */
      applySettings: function () {
        const settings = Settings.getAll();

        // Apply dark mode if enabled
        if (settings.darkMode) {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        // Set values in settings form
        const currencyInput = document.getElementById("currencySymbol");
        if (currencyInput) {
          currencyInput.value = settings.currencySymbol;
        }

        const dateFormatSelect = document.getElementById("dateFormat");
        if (dateFormatSelect) {
          dateFormatSelect.value = settings.dateFormat;
        }

        const darkModeCheckbox = document.getElementById("darkMode");
        if (darkModeCheckbox) {
          darkModeCheckbox.checked = settings.darkMode;
        }

        const languageSelect = document.getElementById("languageSelector");
        if (languageSelect) {
          languageSelect.value = settings.language;
        }

        const showRemainingCheckbox = document.getElementById("showRemaining");
        if (showRemainingCheckbox) {
          showRemainingCheckbox.checked = settings.showRemaining;
        }

        const enableAlertsCheckbox = document.getElementById("enableAlerts");
        if (enableAlertsCheckbox) {
          enableAlertsCheckbox.checked = settings.enableAlerts;
        }

        const startingDaySelect = document.getElementById("startingDay");
        if (startingDaySelect) {
          startingDaySelect.value = settings.startingDay;
        }

        // In applySettings function
        const showDecimalsCheckbox = document.getElementById("showDecimals");
        if (showDecimalsCheckbox) {
          showDecimalsCheckbox.checked = settings.showDecimals;
        }
      },

      openSpreadsheet: function () {
        const urlInput = document.getElementById("budgetSheetUrl");
        if (urlInput && urlInput.value) {
          window.open(urlInput.value, "_blank");
        } else {
          Utils.showToast("No spreadsheet URL configured", "error");
        }
      },

      /**
       * Load user info
       */
      loadUserInfo: function () {
        API.getUserCredentials(
          function (result) {
            const userEmailEl = document.getElementById("userEmail");
            if (userEmailEl) {
              userEmailEl.textContent = result.email || "Not signed in";
            }
          },
          function (error) {
            console.error("Error getting user credentials:", error);
            const userEmailEl = document.getElementById("userEmail");
            if (userEmailEl) {
              userEmailEl.textContent = "Error loading user info";
            }
          }
        );
      },

      /**
       * Save settings
       */
            saveSettings: function () {
        // Get values from form
        const settings = {
          currencySymbol: document.getElementById("currencySymbol").value,
          dateFormat: document.getElementById("dateFormat").value,
          darkMode: document.getElementById("darkMode").checked,
          showRemaining: document.getElementById("showRemaining").checked,
          enableAlerts: document.getElementById("enableAlerts").checked,
          startingDay: document.getElementById("startingDay").value,
          language: document.getElementById("languageSelector").value,
          showDecimals: document.getElementById("showDecimals").checked,
        };
        
        // Save settings to server
        if (SimBudget.Settings.saveAll(settings)) {
          // Apply settings immediately
          SimBudget.applySettings();
          
          // Save sheet URL if provided - also server-side
          const sheetUrl = document.getElementById("budgetSheetUrl").value;
          if (sheetUrl) {
            API.setBudgetSheetUrl(
              sheetUrl,
              function () {
                Utils.showStatus(
                  "Settings saved successfully",
                  false,
                  document.getElementById("settingsStatus"),
                  3000
                );
                // Invalidate all caches when sheet URL changes
                _cache.invalidateAll();
              },
              function (error) {
                Utils.showStatus(
                  "Settings saved but sheet URL could not be saved: " + error,
                  true,
                  document.getElementById("settingsStatus")
                );
              }
            );
          } else {
            Utils.showStatus(
              "Settings saved successfully",
              false,
              document.getElementById("settingsStatus"),
              3000
            );
          }
        } else {
          Utils.showStatus(
            "Error saving settings",
            true,
            document.getElementById("settingsStatus")
          );
        }
      },

      /**
       * Reset settings to defaults
       */
      resetSettings: function () {
        // Reset to defaults
        if (SimBudget.Settings.saveAll(SimBudget.Settings.defaults)) {
          // Apply settings
          SimBudget.applySettings();

          Utils.showStatus(
            "Settings reset to defaults",
            false,
            document.getElementById("settingsStatus"),
            3000
          );
        } else {
          Utils.showStatus(
            "Error resetting settings",
            true,
            document.getElementById("settingsStatus")
          );
        }
      },

      /**
       * Test connection to sheet
       */
      testConnection: function () {
        const sheetUrl = document.getElementById("budgetSheetUrl").value;
        if (!sheetUrl) {
          Utils.showStatus(
            "Please enter a spreadsheet URL",
            true,
            document.getElementById("connectionStatus")
          );
          return;
        }

        // Show loading state
        Utils.showStatus(
          "Testing connection...",
          false,
          document.getElementById("connectionStatus")
        );

        API.verifySheetUrl(
          sheetUrl,
          function (result) {
            Utils.showStatus(
              "Connection successful!",
              false,
              document.getElementById("connectionStatus"),
              3000
            );

            // Invalidate all caches when connection changes
            _cache.invalidateAll();
          },
          function (error) {
            Utils.showStatus(
              "Connection failed: " + error,
              true,
              document.getElementById("connectionStatus")
            );
          }
        );
      },

/**
 * Load data for a specific view with caching and preloading
 * REPLACE the existing loadViewData function in SimBudget's return object
 * @param {string} viewName - Name of the view to load
 * @param {boolean} forceRefresh - Whether to bypass cache and force a refresh
 */
loadViewData: function(viewName, forceRefresh = false) {

  // Skip if already loading the same view
  if (_loadingView === viewName && !forceRefresh) {
    return;
  }

  // Set loading flag
  _loadingView = viewName;

  // CACHE-FIRST STRATEGY: Check cache first unless force refresh
  if (!forceRefresh && _cache.isValid(viewName)) {
    this.renderViewFromCache(viewName);
    _loadingView = null;
    
    // Start preloader if this is the first view and we're not in refresh mode
    if (!_preloader.isRunning && !_cache.areAllPriorityViewsLoaded()) {
      _preloader.start(viewName);
    }
    return;
  }

  // Load from server
  switch (viewName) {
    case "budget":
      this.loadBudgetData();
      break;
    case "expense":
      this.loadExpenseData();
      break;
    case "income":
      this.loadIncomeData();
      break;
    case "recurring":
      this.loadRecurringData();
      break;
    case "netWorth":
      this.loadNetWorthData();
      break;
    case "reports":
      this.loadReportsSheet();
      break;
    case "categories":
      this.loadCategoriesData();
      break;
    case "settings":
      _loadingView = null; 
      break;
    default:
      console.error(`LoadViewData: Unknown view ${viewName}`);
      _loadingView = null;
  }
},

      // In Init.html - modify the loadCategoriesData function
      loadCategoriesData: function () {
        // Get content container
        const contentArea = document.getElementById("categoriesContent");
        if (!contentArea) {
          console.error("Categories content area not found");
          _loadingView = null;
          return;
        }

        // Get or create categories container
        let categoriesContainer = document.getElementById(
          "categories-container"
        );
        if (!categoriesContainer) {
          categoriesContainer = document.createElement("div");
          categoriesContainer.id = "categories-container";
          categoriesContainer.className = "categories-container";
          contentArea.appendChild(categoriesContainer);
        }

        // First check if CategoriesManager is initialized and has data
        if (
          window.CategoriesManager &&
          CategoriesManager._initialized &&
          CategoriesManager._categories &&
          CategoriesManager._categories.length > 0
        ) {
          console.log("CategoriesManager already initialized, skipping load");
          _loadingView = null;
          return;
        }

        // Then check local cache before showing loading state
        const cachedCategories = localStorage.getItem("simbudget_categories");
        const cachedActiveCategories = localStorage.getItem(
          "simbudget_active_categories"
        );

        if (cachedCategories && !window._forceCategoriesRefresh) {
          try {
            // Use cached data
            console.log("Using cached categories from localStorage");
            const parsedCategories = JSON.parse(cachedCategories);
            let activeList = [];

            if (cachedActiveCategories) {
              activeList = JSON.parse(cachedActiveCategories);
            }

            // Store in SimBudget cache too
            _cache.set("categories", parsedCategories);

            // Initialize manager with cached data
            if (
              window.CategoriesManager &&
              typeof CategoriesManager.init === "function"
            ) {
              CategoriesManager.init(parsedCategories, activeList);
            }

            // Clear loading flag
            _loadingView = null;

            // Optionally refresh in background after a delay
            setTimeout(() => {
              if (!window._isViewChanging) {
                API.getCategories(
                  function (result) {
                    // No UI update needed here unless data changed significantly
                  },
                  function (error) {
                    console.log(
                      "Background refresh error (non-critical):",
                      error
                    );
                  },
                  false // Don't force refresh, use server cache
                );
              }
            }, 2000);

            return;
          } catch (e) {
            console.error("Error parsing cached categories:", e);
            // Fall through to API call on error
          }
        }

        // Show loading state ONLY if we couldn't use cache
        categoriesContainer.innerHTML =
          '<div class="categories-loading"><div class="loading-spinner"></div><p>Loading categories...</p></div>';

        // Call API to get categories
        API.getCategories(
          function (result) {
            console.log("Categories data loaded successfully", result);

            // Cache the result
            _cache.set("categories", result.categories);

            // Clear loading flag
            _loadingView = null;
            window._forceCategoriesRefresh = false;

            // Initialize CategoriesManager with data
            if (
              window.CategoriesManager &&
              typeof CategoriesManager.init === "function"
            ) {
              CategoriesManager.init(
                result.categories,
                result.activeCategories
              );
            } else {
              categoriesContainer.innerHTML =
                '<div class="categories-error"><i class="material-icons">error</i><p>CategoriesManager not available</p></div>';
            }
          },
          function (error) {
            console.error("Error loading categories:", error);
            _loadingView = null;
            window._forceCategoriesRefresh = false;

            // Try to use cached data even on error
            if (cachedCategories) {
              try {
                const parsedCategories = JSON.parse(cachedCategories);
                let activeList = [];

                if (cachedActiveCategories) {
                  activeList = JSON.parse(cachedActiveCategories);
                }

                if (
                  window.CategoriesManager &&
                  typeof CategoriesManager.init === "function"
                ) {
                  CategoriesManager.init(parsedCategories, activeList);

                  // Show a toast about using cached data due to error
                  if (window.Utils && typeof Utils.showToast === "function") {
                    Utils.showToast(
                      "Using cached categories - " + error,
                      "warning"
                    );
                  }
                  return;
                }
              } catch (e) {
                console.error(
                  "Error parsing cached categories on error fallback:",
                  e
                );
              }
            }

            // Show error INSIDE container only if we couldn't use cache
            categoriesContainer.innerHTML = `<div class="categories-error">
        <i class="material-icons">error</i>
        <span>Error loading categories: ${error}</span>
      </div>`;
          },
          window._forceCategoriesRefresh || false // Only force refresh if flag is set
        );
      },

      /**
       * Render view using cached data
       * @param {string} viewName - Name of the view to render
       */
      renderViewFromCache: function (viewName) {
        console.log(`Rendering ${viewName} view from cache`);
        const cachedData = _cache.get(viewName);

        if (!cachedData) {
          console.error(`No cached data found for ${viewName} view`);
          return;
        }

        switch (viewName) {
          case "budget":
            this.renderBudgetDashboard(cachedData);
            break;
          case "expense":
            this.renderExpenseView(cachedData);
            break;
          case "income":
            // TODO: Implement income view rendering
            break;
          case "recurring":
            // TODO: Implement recurring view rendering
            break;
          case "netWorth":
            // TODO: Implement net worth view rendering
            break;
          case "reports":
            // TODO: Implement reports view rendering
            break;
          default:
            console.error(`Unknown view name for cache rendering: ${viewName}`);
        }
      },

      /**
       * Load budget data using a single consolidated API call
       */
      loadBudgetData: function() {
      console.log('LoadBudgetData: Starting...');
        // Make sure we have current month/year
  if (typeof _currentMonth === 'undefined') {
    _currentMonth = new Date().getMonth();
    _currentYear = new Date().getFullYear();
    console.log('LoadBudgetData: Set default month/year:', _currentMonth, _currentYear);
  }
      const contentArea = document.getElementById("budgetContent");
      
      // Check cache first
      const cachedData = window.CacheManager.getDashboardData();
      if (cachedData) {
        console.log('LoadBudgetData: Using cached dashboard data');
        SimBudget.renderBudgetDashboard(cachedData);
        _loadingView = null;
        return;
      }
      
      // Show simple loading overlay
      if (contentArea) {
        const existingDashboard = contentArea.querySelector('.dashboard-container');
        if (existingDashboard) {
          // Add loading overlay to existing content
          const overlay = document.createElement('div');
          overlay.className = 'loading-overlay';
          overlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.9);z-index:100;';
          overlay.innerHTML = '<div class="loading-spinner"></div>';
          contentArea.style.position = 'relative';
          contentArea.appendChild(overlay);
        } else {
          // First load - simple loading message
          contentArea.innerHTML = '<div style="padding:40px;text-align:center;"><div class="loading-spinner"></div><p>Loading budget data...</p></div>';
        }
      }
      
      // Load both expenses and recurring data
      let expensesLoaded = false;
      let recurringLoaded = false;
      let expensesData = null;
      let recurringData = null;
      
      const checkAndRender = () => {
        if (expensesLoaded && recurringLoaded) {
          console.log('LoadBudgetData: Both data sources loaded');
          
          // Store in cache
          if (expensesData) {
            window.CacheManager.setExpenses(expensesData, _currentMonth, _currentYear);
          }
          if (recurringData) {
            window.CacheManager.setRecurring(recurringData);
          }
          
          // Calculate and render
          const dashboardData = window.CacheManager.getDashboardData(_currentMonth, _currentYear);
          console.log('LoadBudgetData: Dashboard data structure:', dashboardData);

          if (dashboardData) {
            SimBudget.renderBudgetDashboard(dashboardData);
          } else {
            console.error('LoadBudgetData: Failed to calculate dashboard data');
          }
          
          _loadingView = null;
        }
      };
      
      // Load expenses
      API.getExpenseData(_currentMonth, _currentYear,
        function(result) {
          console.log('LoadBudgetData: Expenses loaded', result.expenses?.length || 0, 'items');
          expensesData = result.expenses || [];
          expensesLoaded = true;
          checkAndRender();
        },
        function(error) {
          console.error('LoadBudgetData: Error loading expenses:', error);
          expensesLoaded = true; // Continue anyway
          checkAndRender();
        }
      );
      
      // Load recurring
      API.getRecurringData(
        function(result) {
          console.log('LoadBudgetData: Recurring loaded', result.recurring?.length || 0, 'items');
          recurringData = result.recurring || [];
          recurringLoaded = true;
          checkAndRender();
        },
        function(error) {
          console.error('LoadBudgetData: Error loading recurring:', error);
          recurringLoaded = true; // Continue anyway
          checkAndRender();
        }
      );
    },


      /**
       * This function remains in init.html even though it's referenced from dashboard.js
       * to maintain original scope access to _currentBudgetData
       */
      updateInfoMessage: function (force = false) {
        if (!this._currentBudgetData) return;

        const el =
          document.getElementById("budget-alert") ||
          document.getElementById("budget-info-message") ||
          document.querySelector(".budget-alert");
        if (!el) return;

        const budget = this._currentBudgetData;
        const totalBudgeted = budget.categories.reduce(
          (sum, cat) =>
            sum + (typeof cat.budgeted === "number" ? cat.budgeted : 0),
          0
        );

        // Determine message type and parameters
        let key,
          msgClass = "info";
        const formatted = Utils.formatCurrency(totalBudgeted);

        if (!budget.income) {
          key = "budget_no_income_tip";
          el.setAttribute("data-param1", formatted);
        } else if (Math.abs(budget.income - totalBudgeted) < 0.01) {
          key = "budget_perfect_match";
          el.setAttribute("data-param1", formatted);
          msgClass = "success";
        } else if (budget.income > totalBudgeted) {
          key = "budget_under_income";
          el.setAttribute("data-param1", formatted);
          el.setAttribute(
            "data-param2",
            Utils.formatCurrency(budget.income - totalBudgeted)
          );
        } else {
          key = "budget_over_income";
          el.setAttribute("data-param1", formatted);
          el.setAttribute(
            "data-param2",
            Utils.formatCurrency(totalBudgeted - budget.income)
          );
          msgClass = "warning";
        }

        // Set translation attributes
        el.setAttribute("data-translate", key);

        // Set initial text content using current translations if available
        if (SimBudget.translations && SimBudget.translations[key]) {
          const params = [
            el.getAttribute("data-param1"),
            el.getAttribute("data-param2"),
          ].filter(Boolean);
          el.textContent = Utils.formatTranslation(
            SimBudget.translations[key],
            params
          );
        }

        // Update class and ensure visibility
        el.className =
          (el.classList.contains("budget-alert")
            ? "budget-alert"
            : "info-message") +
          " " +
          msgClass;
        el.style.display = "block";
      },

      /**
       * Load expense data with reliable grid rendering
       * Always shows the grid with sample data first, then updates with real data if available
       */
      loadExpenseData: function () {
        console.log("Loading expense view...");

        const contentArea = document.getElementById("expenseContent");
        if (!contentArea) {
          console.error("Expense content area not found");
          _loadingView = null;
          return;
        }

        // 1. FIRST create a clean container with unique ID and proper dimensions
        const containerId = "expense-grid-" + Date.now();
        contentArea.innerHTML = `
    <div id="${containerId}" class="monthly-grid-container" 
         style="width:100%; height:100%; position:relative; overflow:auto;">
    </div>
  `;

        // 2. THEN initialize MonthlyGrid with the container
        //    This will show the grid with sample data immediately
        if (window.MonthlyGrid) {
          console.log("Initializing MonthlyGrid with container:", containerId);
          MonthlyGrid.init(containerId);

          // 3. FINALLY (optionally) fetch real data
          //    Grid is already visible, so this is non-blocking
          if (window.API && typeof API.getExpenseData === "function") {
            console.log("Fetching real expense data...");

            // Show subtle loading indicator
            const loadingIndicator = document.createElement("div");
            loadingIndicator.style.position = "absolute";
            loadingIndicator.style.top = "10px";
            loadingIndicator.style.right = "10px";
            loadingIndicator.style.background = "rgba(255,255,255,0.8)";
            loadingIndicator.style.padding = "5px 10px";
            loadingIndicator.style.borderRadius = "4px";
            loadingIndicator.style.fontSize = "12px";
            loadingIndicator.innerHTML = "Loading data...";
            document.getElementById(containerId).appendChild(loadingIndicator);

            API.getExpenseData(
              function (result) {
                console.log("Real expense data loaded successfully");

                // Update grid with real data if available
                if (result && result.success && result.expenses) {
                  MonthlyGrid.setExpenseData(result.expenses);
                }

                // Cache the result
                _cache.set("expense", result.expenses || []);

                // Remove loading indicator
                loadingIndicator.remove();
              },
              function (error) {
                console.log(
                  "Using sample data - couldn't load real data:",
                  error
                );

                // Update loading indicator to show info message
                loadingIndicator.style.background = "rgba(255, 248, 225, 0.9)";
                loadingIndicator.style.border = "1px solid #FFE082";
                loadingIndicator.innerHTML = "Using sample data";

                // Make indicator disappear after 3 seconds
                setTimeout(function () {
                  loadingIndicator.style.opacity = "0";
                  loadingIndicator.style.transition = "opacity 0.5s";

                  // Remove from DOM after fade out
                  setTimeout(function () {
                    loadingIndicator.remove();
                  }, 500);
                }, 3000);
              }
            );
          }
        } else {
          contentArea.innerHTML =
            '<div class="error-message">Error: Grid component not available</div>';
          console.error("MonthlyGrid component not found");
        }

        // Clear loading flag
        _loadingView = null;
      },
   
   
   
   
   
    // PRELOADER CONTROLS
  startPreloader: function(excludeView) {
    _preloader.start(excludeView);
  },

  stopPreloader: function() {
    _preloader.stop();
  },

  getCacheStats: function() {
    return _cache.getStats();
  },

  // CACHE CONTROLS  
  clearCache: function() {
    _cache.invalidateAll();
    console.log("Manual cache clear completed");
  },

  // ENHANCED: Clear cache and reload current view
  refreshCurrentView: function() {
    const currentView = this.Views.getCurrent();
    console.log(`Refreshing current view: ${currentView}`);
    
    // Clear cache for current view and related views
    _cache.invalidateRelated(currentView);
    
    // Stop any running preloader
    _preloader.stop();
    
    // Reload current view with force refresh
    this.loadViewData(currentView, true);
  },
  

// FIX 2: Add missing renderExpenseView function
// ADD this new function to SimBudget's return object:

/**
 * Render expense view from cached data
 * @param {Array} cachedExpenses - Cached expense data
 */
renderExpenseView: function(cachedExpenses) {
  console.log("RenderExpenseView: Rendering from cache with", cachedExpenses.length, "expenses");
  
  const contentArea = document.getElementById("expenseContent");
  if (!contentArea) {
    console.error("RenderExpenseView: Expense content area not found");
    return;
  }

  // Create container for MonthlyGrid
  const containerId = "expense-grid-cached-" + Date.now();
  contentArea.innerHTML = `
    <div id="${containerId}" class="monthly-grid-container" 
         style="width:100%; height:100%; position:relative; overflow:auto;">
    </div>
  `;

  // Initialize MonthlyGrid
  if (window.MonthlyGrid) {
    MonthlyGrid.init(containerId);
    
    // Set the cached expense data
    if (cachedExpenses && cachedExpenses.length > 0) {
      MonthlyGrid.setExpenseData(cachedExpenses);
    } else {
      console.log("RenderExpenseView: No cached expense data available, using sample data");
    }
  } else {
    console.error("RenderExpenseView: MonthlyGrid component not found");
    contentArea.innerHTML = '<div class="error-message">Error: Grid component not available</div>';
  }
},

loadExpenseData: function() {
  console.log("Loading expense view...");
  
  const contentArea = document.getElementById("expenseContent");
  if (!contentArea) {
    console.error("Expense content area not found");
    _loadingView = null;
    return;
  }

  // Create container for MonthlyGrid
  const containerId = "expense-grid-" + Date.now();
  contentArea.innerHTML = `
    <div id="${containerId}" class="monthly-grid-container" 
         style="width:100%; height:100%; position:relative; overflow:auto;">
    </div>
  `;

  // Initialize MonthlyGrid - it will use CacheManager internally
  if (window.MonthlyGrid) {
    console.log("Initializing MonthlyGrid with container:", containerId);
    MonthlyGrid.init(containerId);
  } else {
    contentArea.innerHTML = '<div class="error-message">Error: Grid component not available</div>';
    console.error("MonthlyGrid component not found");
  }

  _loadingView = null;
},
   

// SIMPLIFIED VIEW LOADING: Just trigger preloader once per session
// REPLACE these functions in SimBudget return object:

/**
 * Load income data (stub with one-time preloader trigger)
 */
loadIncomeData: function() {
  console.log("LoadIncomeData: Income view not implemented yet");
  
  const contentArea = document.getElementById("incomeContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Income Management Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  // SIMPLIFIED: Just try to start preloader - it handles session logic internally
  _preloader.start('income');
},

// In Init.html, update the loadRecurringData function:

// In Init.html, replace the loadRecurringData function:

/**
 * Enhanced loadRecurringData function for Init.html
 * Properly uses cache system
 */
loadRecurringData: function() {
  console.log("Loading recurring view...");
  
  const contentArea = document.getElementById("recurringContent");
  if (!contentArea) {
    console.error("Recurring content area not found");
    _loadingView = null;
    return;
  }

  try {
    // Check if RecurringManager exists
    if (!window.RecurringManager || typeof RecurringManager.init !== 'function') {
      throw new Error("RecurringManager component not found");
    }

    // Check cache first
    const cachedData = _cache.get('recurring');
    
    if (cachedData && Array.isArray(cachedData)) {
      console.log("Using cached recurring data:", cachedData.length, "items");
      // Initialize with cached data
      RecurringManager.init('recurringContent', cachedData);
    } else {
      console.log("No cached recurring data, loading fresh");
      // Initialize without data - will load fresh
      RecurringManager.init('recurringContent', null);
    }
    
  } catch (err) {
    console.error("Error initializing RecurringManager:", err);
    contentArea.innerHTML = `
      <div class="error-message">
        <h3>Error Loading Recurring Module</h3>
        <p>${err.message}</p>
      </div>
    `;
  } finally {
    _loadingView = null;
  }
},

/**
 * Load net worth data (stub with one-time preloader trigger)
 */
loadNetWorthData: function() {
  
  const contentArea = document.getElementById("netWorthContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Net Worth Tracking Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  // SIMPLIFIED: Just try to start preloader - it handles session logic internally
  _preloader.start('netWorth');
},

/**
 * Load reports data (stub with one-time preloader trigger)
 */
loadReportsSheet: function() {
  
  const contentArea = document.getElementById("reportsContent");
  if (contentArea) {
    contentArea.innerHTML = '<div style="padding:40px;text-align:center;color:#666;"><h3>Financial Reports Coming Soon</h3></div>';
  }
  
  _loadingView = null;
  // SIMPLIFIED: Just try to start preloader - it handles session logic internally
  _preloader.start('reports');
},





 };
  })();

  // Make debug functions available globally for testing
  window.SimBudgetDebug = {
    /**
     * Force reload budget data from server
     */
    reloadBudget: function () {
      console.log("Debug: Force reloading budget data");
      SimBudget.loadBudgetData();
    },

    /**
     * Clear the cache and reload
     */
    clearCache: function () {
      console.log("Debug: Clearing cache");
      if (window._cache && typeof window._cache.invalidateAll === "function") {
        window._cache.invalidateAll();
        console.log("Cache cleared");
      } else {
        console.log("Global cache not available");
      }
    },

    /**
     * Check current structure and log it
     */
    checkData: function () {
      console.log("Current budget data:", SimBudget._currentBudgetData);

      if (window._cache && typeof window._cache.get === "function") {
        console.log("Cached budget data:", window._cache.get("budget"));
      } else {
        console.log("Cache is not accessible");
      }
    },

    /**
     * Test API connection
     */
    testConnection: function () {
      console.log("Testing API connection...");
      API.testServerConnection(
        function (result) {
          console.log("API Connection successful:", result);
        },
        function (error) {
          console.error("API Connection failed:", error);
        }
      );
    },
  };

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof SimBudget !== "undefined") {
      SimBudget.initialize();
    } else {
      console.error("SimBudget object not found. Initialization failed.");
    }
  });

// Add this to the SimBudget.initialize function in Init.html
// Coordinate cache invalidation with MonthlyGrid component
document.addEventListener('monthlyGrid-cache-cleared', function(event) {
  console.log('Received cache clear event from MonthlyGrid:', event.detail);
  
  // Clear SimBudget's expense cache
  if (window._cache && typeof _cache.invalidate === 'function') {
    console.log('Clearing SimBudget application cache for expenses');
    _cache.invalidate('expense');
    
    // If currently in expense view, reload it
    if (SimBudget.Views.getCurrent() === 'expense') {
      console.log('Currently in expense view, triggering reload');
      // Use setTimeout to avoid potential race conditions
      setTimeout(function() {
        SimBudget.loadViewData('expense', true);
      }, 100);
    }
  }
});


  // Expose global cache for debugging
  window._dataCache = _cache;

  // In Init.html - Add this to your initialization function
  document.addEventListener("language-changed", function () {
    // Refresh category displays
    if (
      window.CategoriesManager &&
      typeof CategoriesManager.renderCategories === "function"
    ) {
      CategoriesManager.renderCategories();
    }

    // Refresh quick expense dropdown
    if (
      window.QuickExpenseEntry &&
      typeof QuickExpenseEntry.updateCategoriesDropdown === "function"
    ) {
      QuickExpenseEntry.updateCategoriesDropdown();
    }

    // Refresh budget table if visible
    if (
      SimBudget._currentView === "budget" &&
      typeof SimBudget.renderBudgetDashboard === "function"
    ) {
      SimBudget.loadViewData("budget", true);
    }
  });

  // In settings.js.html - Dispatch event when language changes
  function changeLanguage(langCode) {
    // Existing code...

    // Dispatch language change event
    document.dispatchEvent(new CustomEvent("language-changed"));
  }
</script>
