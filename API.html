<script>/**
 * API.html - API abstraction layer for SimBudget
 * Creates a clean interface between UI and server code
 * Rewritten for modular loading approach
 */

// SimBudget API namespace
var API = (function() {
  // Private variables
  var _lastError = null;
  
  // Public methods
  return {
    /**
     * Test connection to server and spreadsheet
     * @param {string} sheetUrl - The Google Sheet URL to test
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    testConnection: function(sheetUrl, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .testServerConnection(sheetUrl);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },

/**
 * Get translations for UI strings
 * @param {string} languageCode - Target language code
 * @param {Function} successCallback - Called on success
 * @param {Function} errorCallback - Called on error
 * @param {boolean} [bustCache=false] - Whether to bypass cache
 */
getTranslations: function(languageCode, successCallback, errorCallback, bustCache) {
  try {
    google.script.run
      .withSuccessHandler(function(translations) {
        successCallback({ success: true, translations: translations });
      })
      .withFailureHandler(function(error) {
        _lastError = error;
        errorCallback(error);
      })
      .getTranslatedUI(languageCode, bustCache || false);
  } catch (e) {
    _lastError = e.message || String(e);
    errorCallback(_lastError);
  }
},

/**
 * Set user language preference
 * @param {string} languageCode - Language code to set
 * @param {Function} successCallback - Called on success
 * @param {Function} errorCallback - Called on error
 */
setUserLanguage: function(languageCode, successCallback, errorCallback) {
  try {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          successCallback(result);
        } else {
          _lastError = result && result.error ? result.error : "Unknown error";
          errorCallback(_lastError);
        }
      })
      .withFailureHandler(function(error) {
        _lastError = error;
        errorCallback(error);
      })
      .setUserLanguage(languageCode);
  } catch (e) {
    _lastError = e.message || String(e);
    errorCallback(_lastError);
  }
},
    
    /**
     * Set budget sheet URL
     * @param {string} url - The sheet URL to set
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    setBudgetSheetUrl: function(url, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .setBudgetSheetUrl(url);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Verify sheet URL and accessibility
     * @param {string} url - The sheet URL to verify
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    verifySheetUrl: function(url, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .verifySheetUrl(url);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Set current month and year
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    setCurrentMonthYear: function(successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .setCurrentMonthYear();
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Set specific month and year
     * @param {string} month - Month name (January, February, etc.)
     * @param {number|string} year - Year (e.g., 2025)
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    setMonthYear: function(month, year, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .setMonthYear(month, year);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Get user credentials
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    getUserCredentials: function(successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .getUserCredentials();
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Set user property
     * @param {string} key - Property key
     * @param {string} value - Property value
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    setUserProperty: function(key, value, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .setUserProperty(key, value);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Update budget value for a category
     * @param {string} categoryName - Name of the category
     * @param {number|string} budgetValue - New budget value
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    updateBudgetValue: function(categoryName, budgetValue, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .updateBudgetValue(categoryName, budgetValue);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Save expense
     * @param {Object} expense - The expense data to save
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    saveExpense: function(expense, successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .saveExpense(expense);
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    

/**
 * Get all dashboard data in a single call
 * @param {Function} successCallback - Called on success
 * @param {Function} errorCallback - Called on error
 */
getDashboardData: function(successCallback, errorCallback) {
  try {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          successCallback(result);
        } else {
          _lastError = result && result.error ? result.error : "Unknown error";
          errorCallback(_lastError);
        }
      })
      .withFailureHandler(function(error) {
        _lastError = error;
        errorCallback(error);
      })
      .getDashboardData();
  } catch (e) {
    _lastError = e.message || String(e);
    errorCallback(_lastError);
  }
},


    
    /**
     * Get expense data
     * @param {Function} successCallback - Called on success
     * @param {Function} errorCallback - Called on error
     */
    getExpenseData: function(successCallback, errorCallback) {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              successCallback(result);
            } else {
              _lastError = result && result.error ? result.error : "Unknown error";
              errorCallback(_lastError);
            }
          })
          .withFailureHandler(function(error) {
            _lastError = error;
            errorCallback(error);
          })
          .getExpenseData();
      } catch (e) {
        _lastError = e.message || String(e);
        errorCallback(_lastError);
      }
    },
    
    /**
     * Gets the last error that occurred in any API call
     * @return {string} Last error message
     */
    getLastError: function() {
      return _lastError;
    }
  };
})();

</script>
